<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š {{ company.corp_name }} - ì¬ë¬´ì œí‘œ ëŒ€ì‹œë³´ë“œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .ai-analysis-content {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            max-height: 500px;
            overflow-y: auto;
        }

        .ai-analysis-text {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }

        .ai-analysis-text h6 {
            margin-top: 15px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .ai-analysis-text strong {
            color: #007bff;
            font-weight: 600;
        }

                 .ai-analysis-text .fas {
             margin-right: 5px;
         }

         .ai-year-select {
             min-width: 100px;
             font-size: 13px;
         }

         .chart-container .d-flex h4 {
             color: #495057;
         }

         /* ì¬ë¬´ìƒíƒœí‘œ ë°•ìŠ¤ ì‹œê°í™” ìŠ¤íƒ€ì¼ - 3ë¶„í•  êµ¬ì¡° */
         .balance-sheet-container {
             display: flex;
             justify-content: center;
             align-items: center;
             padding: 20px;
             min-height: 400px;
             background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
             border-radius: 12px;
             margin: 20px 0;
         }

         .single-balance-box {
             position: relative;
             border-radius: 8px;
             box-shadow: 0 4px 15px rgba(0,0,0,0.1);
             transition: all 0.3s ease;
             display: flex;
             width: 600px;
             height: 300px;
             background: white;
             overflow: hidden;
         }

         .single-balance-box:hover {
             transform: translateY(-3px);
             box-shadow: 0 8px 25px rgba(0,0,0,0.15);
         }

         .assets-section {
             flex: 1;
             background: linear-gradient(180deg, #28a745 0%, #20c997 100%);
             color: white;
             display: flex;
             flex-direction: column;
             position: relative;
         }

         .liabilities-equity-section {
             flex: 1;
             display: flex;
             flex-direction: column;
         }

         .liability-section {
             flex: 1;
             background: linear-gradient(180deg, #dc3545 0%, #fd7e14 100%);
             color: white;
             display: flex;
             flex-direction: column;
             border-bottom: 2px solid rgba(255,255,255,0.3);
         }

         .equity-section {
             flex: 1;
             background: linear-gradient(180deg, #6f42c1 0%, #e83e8c 100%);
             color: white;
             display: flex;
             flex-direction: column;
         }

         .section-title {
             text-align: center;
             padding: 8px 0;
             font-weight: bold;
             font-size: 16px;
             margin-bottom: 10px;
         }
         
         .section-title i {
             margin-right: 6px;
         }

         .section-content {
             padding: 15px;
             text-align: center;
             flex: 1;
             display: flex;
             flex-direction: column;
             justify-content: center;
             position: relative;
         }
         
         .ratio-display {
             position: absolute;
             bottom: 8px;
             right: 12px;
             font-size: 10px;
             opacity: 0.8;
             font-weight: bold;
             background: rgba(0,0,0,0.2);
             padding: 2px 6px;
             border-radius: 10px;
         }

         .amount-display {
             font-size: 18px;
             font-weight: bold;
             margin: 8px 0;
             text-shadow: 0 2px 4px rgba(0,0,0,0.3);
         }

         .amount-label {
             font-size: 12px;
             opacity: 0.9;
             margin-bottom: 5px;
         }

         .assets-section .amount-display {
             font-size: 24px;
         }

         .assets-section .section-title {
             font-size: 20px;
             padding: 12px 0;
         }

         .balance-divider {
             width: 2px;
             background: rgba(0,0,0,0.1);
         }

         @media (max-width: 768px) {
             .single-balance-box {
                 width: 100%;
                 max-width: 500px;
                 height: 250px;
             }
             
             .amount-display {
                 font-size: 16px;
             }
             
             .assets-section .amount-display {
                 font-size: 20px;
             }
             
             .section-title {
                 font-size: 14px;
             }
             
             .assets-section .section-title {
                 font-size: 16px;
             }
             
             .ratio-display {
                 font-size: 9px;
                 bottom: 6px;
                 right: 8px;
             }
         }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        
        .company-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.2s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .metric-change {
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        
        .nav-pills .nav-link {
            border-radius: 25px;
            padding: 10px 20px;
            margin: 0 5px;
            font-weight: 600;
        }
        
        .nav-pills .nav-link.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }
        
        .loading-chart {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        
        .btn-back {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 25px;
            padding: 10px 20px;
            transition: all 0.3s ease;
        }
        
        .btn-back:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            transform: translateY(-2px);
        }
        
        .stock-info {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-left: 15px;
        }
        
        .year-selector {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <div class="header-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="company-info">
                        <h1 class="mb-3">
                            <i class="fas fa-building"></i> {{ company.corp_name }}
                            {% if company.stock_code %}
                                <span class="stock-info">
                                    <i class="fas fa-chart-line"></i> {{ company.stock_code }}
                                </span>
                            {% else %}
                                <span class="stock-info">
                                    <i class="fas fa-info-circle"></i> ë¹„ìƒì¥
                                </span>
                            {% endif %}
                        </h1>
                        <p class="mb-2">
                            <i class="fas fa-barcode"></i> ê¸°ì—…ì½”ë“œ: {{ company.corp_code }}
                        </p>
                        <p class="mb-0">
                            <i class="fas fa-calendar"></i> ìµœì¢… ìˆ˜ì •: {{ company.modify_date }}
                        </p>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/" class="btn btn-back">
                        <i class="fas fa-arrow-left"></i> ê²€ìƒ‰ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Year and Report Type Selector -->
        <div class="year-selector">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt"></i> ì¡°íšŒ ì¡°ê±´ ì„ íƒ
                    </h5>
                </div>
                <div class="col-md-9">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="specificYear" class="form-label mb-1">ğŸ“… ì‚¬ì—…ì—°ë„</label>
                            <select id="specificYear" class="form-select" onchange="updateSpecificData()">
                                <option value="">ì—°ë„ ì„ íƒ</option>
                                <option value="2024">2024ë…„</option>
                                <option value="2023" selected>2023ë…„</option>
                                <option value="2022">2022ë…„</option>
                                <option value="2021">2021ë…„</option>
                                <option value="2020">2020ë…„</option>
                                <option value="2019">2019ë…„</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="reportType" class="form-label mb-1">ğŸ“Š ë³´ê³ ì„œ ìœ í˜•</label>
                            <select id="reportType" class="form-select" onchange="updateSpecificData()">
                                <option value="11011" selected>ì‚¬ì—…ë³´ê³ ì„œ (ì—°ê°„)</option>
                                <option value="11014">3ë¶„ê¸°ë³´ê³ ì„œ</option>
                                <option value="11012">ë°˜ê¸°ë³´ê³ ì„œ</option>
                                <option value="11013">1ë¶„ê¸°ë³´ê³ ì„œ</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="yearRange" class="form-label mb-1">ğŸ“ˆ ì¶”ì„¸ë¶„ì„ ë²”ìœ„</label>
                            <select id="yearRange" class="form-select" onchange="updateCharts()">
                                <option value="2021,2022,2023">2021-2023 (3ë…„)</option>
                                <option value="2020,2021,2022,2023">2020-2023 (4ë…„)</option>
                                <option value="2019,2020,2021,2022,2023">2019-2023 (5ë…„)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Metrics -->
        <div id="metricsSection">
            <div class="loading-chart">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">ë°ì´í„° ë¡œë”© ì¤‘...</span>
                </div>
                <p class="mt-3">ì¬ë¬´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
        </div>

        <!-- Chart Navigation -->
        <ul class="nav nav-pills justify-content-center mb-4" id="chartTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="trend-tab" data-bs-toggle="pill" 
                        data-bs-target="#trend-pane" type="button" role="tab">
                    <i class="fas fa-chart-line"></i> ì¶”ì„¸ ë¶„ì„
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="structure-tab" data-bs-toggle="pill" 
                        data-bs-target="#structure-pane" type="button" role="tab">
                    <i class="fas fa-chart-pie"></i> êµ¬ì¡° ë¶„ì„
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ratios-tab" data-bs-toggle="pill" 
                        data-bs-target="#ratios-pane" type="button" role="tab">
                    <i class="fas fa-calculator"></i> ì¬ë¬´ë¹„ìœ¨
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="comparison-tab" data-bs-toggle="pill" 
                        data-bs-target="#comparison-pane" type="button" role="tab">
                    <i class="fas fa-balance-scale"></i> ë‹¹ê¸°vsì „ê¸° ë¹„êµ
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ai-analysis-tab" data-bs-toggle="pill" 
                        data-bs-target="#ai-analysis-pane" type="button" role="tab">
                    <i class="fas fa-robot"></i> AI ë¶„ì„
                </button>
            </li>
        </ul>

        <!-- Chart Content -->
        <div class="tab-content" id="chartContent">
            <!-- Trend Analysis Tab -->
            <div class="tab-pane fade show active" id="trend-pane" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-chart-line text-primary"></i> ë§¤ì¶œì•¡ ì¶”ì„¸
                            </h4>
                            <div id="revenueChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="mt-3">ì°¨íŠ¸ ìƒì„± ì¤‘...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-chart-line text-success"></i> ìˆœì´ìµ ì¶”ì„¸
                            </h4>
                            <div id="profitChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-success"></div>
                                    <p class="mt-3">ì°¨íŠ¸ ìƒì„± ì¤‘...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Structure Analysis Tab -->
            <div class="tab-pane fade" id="structure-pane" role="tabpanel">
                <!-- ì¬ë¬´ìƒíƒœí‘œ ë°•ìŠ¤ ì‹œê°í™” -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="chart-container">
                            <h4 class="mb-3 text-center">
                                <i class="fas fa-building text-primary"></i> ì¬ë¬´ìƒíƒœí‘œ êµ¬ì¡°
                            </h4>
                            <div id="balanceSheetBoxes">
                                <div class="loading-chart">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="mt-3">ì¬ë¬´ìƒíƒœí‘œ ë°•ìŠ¤ ìƒì„± ì¤‘...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ê¸°ì¡´ ì°¨íŠ¸ë“¤ -->
                <div class="row">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-chart-pie text-info"></i> ìì‚° êµ¬ì¡°
                            </h4>
                            <div id="assetsChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-info"></div>
                                    <p class="mt-3">ì°¨íŠ¸ ìƒì„± ì¤‘...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-chart-bar text-warning"></i> ìë³¸ vs ë¶€ì±„
                            </h4>
                            <div id="debtEquityChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-warning"></div>
                                    <p class="mt-3">ì°¨íŠ¸ ìƒì„± ì¤‘...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Ratios Tab -->
            <div class="tab-pane fade" id="ratios-pane" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-chart-line text-success"></i> ìˆ˜ìµì„± ë¹„ìœ¨
                            </h4>
                            <div id="profitabilityChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-success"></div>
                                    <p class="mt-3">ì°¨íŠ¸ ìƒì„± ì¤‘...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-shield-alt text-primary"></i> ì•ˆì •ì„± ë¹„ìœ¨
                            </h4>
                            <div id="stabilityChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="mt-3">ì°¨íŠ¸ ìƒì„± ì¤‘...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-seedling text-info"></i> ì„±ì¥ì„± ë¹„ìœ¨
                            </h4>
                            <div id="growthChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-info"></div>
                                    <p class="mt-3">ì°¨íŠ¸ ìƒì„± ì¤‘...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-radar-chart text-warning"></i> ì¢…í•© ë¹„ìœ¨ ë¶„ì„
                            </h4>
                            <div id="comparisonChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-warning"></div>
                                    <p class="mt-3">ì°¨íŠ¸ ìƒì„± ì¤‘...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comparison Tab -->
            <div class="tab-pane fade" id="comparison-pane" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-chart-bar text-primary"></i> ì†ìµê³„ì‚°ì„œ ë¹„êµ
                            </h4>
                            <div id="incomeComparisonChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="mt-3">ì°¨íŠ¸ ìƒì„± ì¤‘...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-chart-bar text-success"></i> ì¬ë¬´ìƒíƒœí‘œ ë¹„êµ
                            </h4>
                            <div id="balanceComparisonChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-success"></div>
                                    <p class="mt-3">ì°¨íŠ¸ ìƒì„± ì¤‘...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-chart-line text-warning"></i> ì¦ê°ë¥  ë¶„ì„
                            </h4>
                            <div id="growthAnalysisChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-warning"></div>
                                    <p class="mt-3">ì°¨íŠ¸ ìƒì„± ì¤‘...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-table text-info"></i> ìƒì„¸ ë¹„êµ ë°ì´í„°
                            </h4>
                            <div id="comparisonDataTable">
                                <div class="loading-chart">
                                    <div class="spinner-border text-info"></div>
                                    <p class="mt-3">ë°ì´í„° ë¡œë”© ì¤‘...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Analysis Tab -->
            <div class="tab-pane fade" id="ai-analysis-pane" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-robot text-primary"></i> AI ì¬ë¬´ì œí‘œ ë¶„ì„
                            </h4>
                            <div id="aiAnalysisContent">
                                <div class="loading-chart">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="mt-3">AI ë¶„ì„ ì¤‘...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3" id="aiComparisonTitle">
                                <i class="fas fa-chart-line text-success"></i> AI ë¹„êµ ë¶„ì„
                            </h4>
                            <div id="aiComparisonContent">
                                <div class="loading-chart">
                                    <div class="spinner-border text-success"></div>
                                    <p class="mt-3">AI ë¹„êµ ë¶„ì„ ì¤‘...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const corpCode = '{{ corp_code }}';
        let currentFinancialData = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, checking Plotly...');
            
            // Plotly ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (typeof Plotly === 'undefined') {
                console.error('Plotly library not loaded!');
                document.getElementById('revenueChart').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Plotly ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
                    </div>
                `;
                document.getElementById('profitChart').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Plotly ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
                    </div>
                `;
                return;
            }
            
            console.log('Plotly loaded successfully');
            loadLatestFinancialData();
            updateCharts();
            
            // ì´ˆê¸° ë¶„ì„ì—°ë„ì— ë”°ë¥¸ AI ë¶„ì„ ë¡œë“œ
            const initialYear = document.getElementById('specificYear').value || '2023';
            loadAIFinancialAnalysis(initialYear);
            updateAIComparisonWithPreviousYear(initialYear);
        });

        // ìµœì‹  ì¬ë¬´ ë°ì´í„° ë¡œë“œ (ë©”íŠ¸ë¦­ í‘œì‹œìš©)
        async function loadLatestFinancialData() {
            const year = document.getElementById('specificYear').value || '2023';
            const reportType = document.getElementById('reportType').value || '11011';
            
            try {
                const response = await fetch(`/api/financial/${corpCode}/${year}?reprt_code=${reportType}`);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('metricsSection').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${year}ë…„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì—°ë„ë‚˜ ë³´ê³ ì„œ ìœ í˜•ì„ ì‹œë„í•´ë³´ì„¸ìš”.
                        </div>
                    `;
                    return;
                }

                currentFinancialData = data;
                displayMetrics(data);
                
            } catch (error) {
                console.error('Error loading financial data:', error);
                document.getElementById('metricsSection').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                    </div>
                `;
            }
        }

        // ê°œë³„ ì‚¬ì—…ì—°ë„/ë³´ê³ ì„œ ìœ í˜• ë³€ê²½ì‹œ ë°ì´í„° ì—…ë°ì´íŠ¸
        async function updateSpecificData() {
            const year = document.getElementById('specificYear').value;
            const reportType = document.getElementById('reportType').value;
            
            if (!year) {
                document.getElementById('metricsSection').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-calendar-alt"></i>
                        ì‚¬ì—…ì—°ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.
                    </div>
                `;
                return;
            }
            
            console.log(`ì‚¬ì—…ì—°ë„: ${year}, ë³´ê³ ì„œ ìœ í˜•: ${reportType}ë¡œ ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘...`);
            
            // ë©”íŠ¸ë¦­ ì„¹ì…˜ ë¡œë”© ìƒíƒœë¡œ ë³€ê²½
            document.getElementById('metricsSection').innerHTML = `
                <div class="loading-chart">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ë°ì´í„° ë¡œë”© ì¤‘...</span>
                    </div>
                    <p class="mt-3">${year}ë…„ ${getReportTypeName(reportType)} ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            `;
            
            // ë©”íŠ¸ë¦­ ë°ì´í„° ìƒˆë¡œ ë¡œë“œ
            await loadLatestFinancialData();
            
            // AI ì¬ë¬´ì œí‘œ ë¶„ì„ ì—…ë°ì´íŠ¸ (í•­ìƒ ì„ íƒ ì—°ë„ë¡œ ì—…ë°ì´íŠ¸)
            loadAIFinancialAnalysis(year);
            
            // AI ë¹„êµ ë¶„ì„ ì—…ë°ì´íŠ¸ (ì„ íƒ ì—°ë„ vs ì „ë…„ë„)
            await updateAIComparisonWithPreviousYear(year);
            
            // êµ¬ì¡° ë¶„ì„ ì—…ë°ì´íŠ¸ (ì¬ë¬´ìƒíƒœí‘œ ë°•ìŠ¤ í¬í•¨)
            loadStructureCharts();
        }

        // ë³´ê³ ì„œ ìœ í˜• ì½”ë“œë¥¼ ì´ë¦„ìœ¼ë¡œ ë³€í™˜
        function getReportTypeName(reportCode) {
            const reportNames = {
                '11011': 'ì‚¬ì—…ë³´ê³ ì„œ',
                '11012': 'ë°˜ê¸°ë³´ê³ ì„œ', 
                '11013': '1ë¶„ê¸°ë³´ê³ ì„œ',
                '11014': '3ë¶„ê¸°ë³´ê³ ì„œ'
            };
            return reportNames[reportCode] || 'ë³´ê³ ì„œ';
        }

        // ì£¼ìš” ì§€í‘œ í‘œì‹œ
        function displayMetrics(data) {
            const rawData = data.raw_data || [];
            
            // ì£¼ìš” ì§€í‘œ ì¶”ì¶œ
            const metrics = {
                revenue: findMetric(rawData, 'ë§¤ì¶œì•¡', 'IS'),
                profit: findMetric(rawData, 'ë‹¹ê¸°ìˆœì´ìµ', 'IS'),
                assets: findMetric(rawData, 'ìì‚°ì´ê³„', 'BS'),
                equity: findMetric(rawData, 'ìë³¸ì´ê³„', 'BS')
            };

            let html = '<div class="row">';
            
            if (metrics.revenue) {
                html += createMetricCard('ë§¤ì¶œì•¡', metrics.revenue, 'fa-chart-line', 'primary');
            }
            if (metrics.profit) {
                html += createMetricCard('ìˆœì´ìµ', metrics.profit, 'fa-coins', 'success');
            }
            if (metrics.assets) {
                html += createMetricCard('ìì‚°ì´ê³„', metrics.assets, 'fa-building', 'info');
            }
            if (metrics.equity) {
                html += createMetricCard('ìë³¸ì´ê³„', metrics.equity, 'fa-piggy-bank', 'warning');
            }
            
            html += '</div>';
            
            document.getElementById('metricsSection').innerHTML = html;
        }

        // ì§€í‘œ ì°¾ê¸° í—¬í¼ í•¨ìˆ˜
        function findMetric(rawData, accountName, sjDiv) {
            for (const item of rawData) {
                if (item.account_name.includes(accountName) && item.sj_div === sjDiv) {
                    return item;
                }
            }
            return null;
        }

        // ë©”íŠ¸ë¦­ ì¹´ë“œ ìƒì„±
        function createMetricCard(title, metric, icon, color) {
            const currentAmount = metric.current_year.amount;
            const previousAmount = metric.previous_year.amount;
            const change = previousAmount > 0 ? ((currentAmount - previousAmount) / previousAmount * 100) : 0;
            const changeClass = change >= 0 ? 'positive' : 'negative';
            const changeIcon = change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            
            return `
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card">
                        <div class="text-${color} mb-2">
                            <i class="fas ${icon} fa-2x"></i>
                        </div>
                        <div class="metric-value">
                            ${formatKoreanWon(currentAmount)}
                        </div>
                        <div class="metric-label">${title}</div>
                        <div class="metric-change ${changeClass}">
                            <i class="fas ${changeIcon}"></i>
                            ${Math.abs(change).toFixed(1)}%
                        </div>
                    </div>
                </div>
            `;
        }

        // í•œêµ­ ì›í™” í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        function formatKoreanWon(amount) {
            const trillion = Math.floor(amount / 1_000_000_000_000);
            const billion = Math.floor((amount % 1_000_000_000_000) / 1_000_000_000);
            
            if (trillion > 0) {
                if (billion > 0) {
                    return `${trillion}.${Math.floor(billion/100)}ì¡°ì›`;
                } else {
                    return `${trillion}ì¡°ì›`;
                }
            } else if (billion > 0) {
                return `${billion.toLocaleString()}ì–µì›`;
            } else {
                return `${Math.floor(amount / 100_000_000).toLocaleString()}ì–µì›`;
            }
        }

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        async function updateCharts() {
            const yearRange = document.getElementById('yearRange').value;
            
            // ì¶”ì„¸ ì°¨íŠ¸ ë¡œë“œ
            loadTrendCharts(yearRange);
            
            // êµ¬ì¡° ì°¨íŠ¸ ë¡œë“œ
            loadStructureCharts();
            
            // ì¬ë¬´ë¹„ìœ¨ ì°¨íŠ¸ ë¡œë“œ
            loadRatioCharts(yearRange);
            
            // ë‹¹ê¸°vsì „ê¸° ë¹„êµ ì°¨íŠ¸ ë¡œë“œ
            loadComparisonCharts(yearRange);
            
            // AI ë¶„ì„ ë¡œë“œ
            loadAIAnalysis(yearRange);
        }

        // ì¶”ì„¸ ì°¨íŠ¸ ë¡œë“œ
        async function loadTrendCharts(years) {
            try {
                console.log('Loading trend charts for years:', years);
                const response = await fetch(`/api/chart/${corpCode}?type=trend&years=${years}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const charts = await response.json();
                console.log('Received charts data:', charts);
                
                if (charts.error) {
                    console.error('Chart error:', charts.error);
                    document.getElementById('revenueChart').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            ë§¤ì¶œì•¡ ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨: ${charts.error}
                        </div>
                    `;
                    document.getElementById('profitChart').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            ìˆœì´ìµ ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨: ${charts.error}
                        </div>
                    `;
                    return;
                }

                if (charts.revenue_trend) {
                    console.log('Creating revenue chart...');
                    document.getElementById('revenueChart').innerHTML = ''; // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                    Plotly.newPlot('revenueChart', charts.revenue_trend.data, charts.revenue_trend.layout);
                    console.log('Revenue chart created successfully');
                } else {
                    document.getElementById('revenueChart').innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            ë§¤ì¶œì•¡ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    `;
                }
                
                if (charts.profit_trend) {
                    console.log('Creating profit chart...');
                    document.getElementById('profitChart').innerHTML = ''; // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                    Plotly.newPlot('profitChart', charts.profit_trend.data, charts.profit_trend.layout);
                    console.log('Profit chart created successfully');
                } else {
                    document.getElementById('profitChart').innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            ìˆœì´ìµ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading trend charts:', error);
                document.getElementById('revenueChart').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        ë§¤ì¶œì•¡ ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨: ${error.message}
                    </div>
                `;
                document.getElementById('profitChart').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        ìˆœì´ìµ ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨: ${error.message}
                    </div>
                `;
            }
        }

        // êµ¬ì¡° ì°¨íŠ¸ ë¡œë“œ
        async function loadStructureCharts() {
            try {
                console.log('Loading structure charts...');
                const response = await fetch(`/api/chart/${corpCode}?type=structure`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const charts = await response.json();
                console.log('Received structure charts data:', charts);
                
                if (charts.error) {
                    console.error('Chart error:', charts.error);
                    document.getElementById('assetsChart').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            ìì‚°êµ¬ì¡° ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨: ${charts.error}
                        </div>
                    `;
                    document.getElementById('debtEquityChart').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            ìë³¸vsë¶€ì±„ ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨: ${charts.error}
                        </div>
                    `;
                    return;
                }

                if (charts.assets_structure) {
                    console.log('Creating assets chart...');
                    document.getElementById('assetsChart').innerHTML = ''; // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                    Plotly.newPlot('assetsChart', charts.assets_structure.data, charts.assets_structure.layout);
                    console.log('Assets chart created successfully');
                } else {
                    document.getElementById('assetsChart').innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            ìì‚°êµ¬ì¡° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    `;
                }
                
                if (charts.debt_equity) {
                    console.log('Creating debt-equity chart...');
                    document.getElementById('debtEquityChart').innerHTML = ''; // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                    Plotly.newPlot('debtEquityChart', charts.debt_equity.data, charts.debt_equity.layout);
                    console.log('Debt-equity chart created successfully');
                } else {
                    document.getElementById('debtEquityChart').innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            ìë³¸vsë¶€ì±„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    `;
                }
                
                // ì¬ë¬´ìƒíƒœí‘œ ë°•ìŠ¤ ìƒì„±
                createBalanceSheetBoxes();
                
            } catch (error) {
                console.error('Error loading structure charts:', error);
                document.getElementById('assetsChart').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        ìì‚°êµ¬ì¡° ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨: ${error.message}
                    </div>
                `;
                document.getElementById('debtEquityChart').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        ìë³¸vsë¶€ì±„ ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨: ${error.message}
                    </div>
                                 `;
                
                // ì—ëŸ¬ ì‹œì—ë„ ì¬ë¬´ìƒíƒœí‘œ ë°•ìŠ¤ ìƒì„± ì‹œë„
                createBalanceSheetBoxes();
             }
         }

         // ì¬ë¬´ìƒíƒœí‘œ ë°•ìŠ¤ ì‹œê°í™” ìƒì„±
         async function createBalanceSheetBoxes() {
             try {
                 console.log('Creating balance sheet boxes...');
                 
                 // í˜„ì¬ ì„ íƒëœ ì—°ë„ì˜ ì¬ë¬´ë°ì´í„° ì‚¬ìš©
                 const year = document.getElementById('specificYear').value || '2023';
                 const reportType = document.getElementById('reportType').value || '11011';
                 
                 const response = await fetch(`/api/financial/${corpCode}/${year}?reprt_code=${reportType}`);
                 const data = await response.json();
                 
                 if (data.error) {
                     document.getElementById('balanceSheetBoxes').innerHTML = `
                         <div class="alert alert-warning">
                             <i class="fas fa-exclamation-triangle"></i>
                             ì¬ë¬´ìƒíƒœí‘œ ë°•ìŠ¤ ìƒì„± ì‹¤íŒ¨: ${data.error}
                         </div>
                     `;
                     return;
                 }
                 
                 // ì¬ë¬´ìƒíƒœí‘œ ì£¼ìš” í•­ëª© ì¶”ì¶œ (ì˜¬ë°”ë¥¸ ë°ì´í„° êµ¬ì¡° ì‚¬ìš©)
                 console.log('Balance Sheet Data:', data.balance_sheet);
                 
                 // ì‹¤ì œ API ì‘ë‹µ êµ¬ì¡°ì— ë§ê²Œ ë°ì´í„° ì¶”ì¶œ
                 const assets = data.balance_sheet?.assets?.ìì‚°ì´ê³„?.current_year?.amount || 
                               data.balance_sheet?.assets?.ìì‚°?.current_year?.amount || 0;
                               
                 const liabilities = data.balance_sheet?.liabilities?.ë¶€ì±„ì´ê³„?.current_year?.amount || 
                                   data.balance_sheet?.liabilities?.ë¶€ì±„?.current_year?.amount || 0;
                                   
                 const equity = data.balance_sheet?.equity?.ìë³¸ì´ê³„?.current_year?.amount || 
                               data.balance_sheet?.equity?.ìë³¸?.current_year?.amount || 
                               (assets - liabilities);
                               
                 console.log('Extracted values:', { assets, liabilities, equity });
                 
                 // ì´ê³„ ê³„ì‚°
                 const total = assets;
                 
                 // ë¹„ìœ¨ ê³„ì‚°
                 const assetsRatio = total > 0 ? ((assets / total) * 100).toFixed(1) : 0;
                 const liabilitiesRatio = total > 0 ? ((liabilities / total) * 100).toFixed(1) : 0;
                 const equityRatio = total > 0 ? ((equity / total) * 100).toFixed(1) : 0;
                 
                 // ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜
                 function formatAmount(amount) {
                     if (amount >= 1000000000000) return (amount / 1000000000000).toFixed(1) + 'ì¡°ì›';
                     if (amount >= 100000000) return (amount / 100000000).toFixed(1) + 'ì–µì›';
                     if (amount >= 10000) return (amount / 10000).toFixed(1) + 'ë§Œì›';
                     return amount.toLocaleString() + 'ì›';
                 }
                 
                 // 3ë¶„í•  ë°•ìŠ¤ HTML ìƒì„± (ê°œì„ ëœ êµ¬ì¡°)
                 const boxesHTML = `
                     <div class="balance-sheet-container">
                         <div class="single-balance-box">
                             <!-- ì™¼ìª½: ìì‚° ì„¹ì…˜ -->
                             <div class="assets-section">
                                 <div class="section-content">
                                     <div class="section-title">
                                         <i class="fas fa-building"></i> ìì‚°
                                     </div>
                                     <div class="amount-display">${formatAmount(assets)}</div>
                                     <div class="amount-label">${year}ë…„ ê¸°ì¤€</div>
                                     <div class="ratio-display">${assetsRatio}%</div>
                                 </div>
                             </div>
                             
                             <!-- ê°€ìš´ë° êµ¬ë¶„ì„  -->
                             <div class="balance-divider"></div>
                             
                             <!-- ì˜¤ë¥¸ìª½: ë¶€ì±„ + ìë³¸ ì„¹ì…˜ -->
                             <div class="liabilities-equity-section">
                                 <!-- ìƒë‹¨: ë¶€ì±„ ì„¹ì…˜ -->
                                 <div class="liability-section">
                                     <div class="section-content">
                                         <div class="section-title">
                                             <i class="fas fa-credit-card"></i> ë¶€ì±„
                                         </div>
                                         <div class="amount-display">${formatAmount(liabilities)}</div>
                                         <div class="ratio-display">${liabilitiesRatio}%</div>
                                     </div>
                                 </div>
                                 
                                 <!-- í•˜ë‹¨: ìë³¸ ì„¹ì…˜ -->
                                 <div class="equity-section">
                                     <div class="section-content">
                                         <div class="section-title">
                                             <i class="fas fa-coins"></i> ìë³¸
                                         </div>
                                         <div class="amount-display">${formatAmount(equity)}</div>
                                         <div class="ratio-display">${equityRatio}%</div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                 `;
                 
                 document.getElementById('balanceSheetBoxes').innerHTML = boxesHTML;
                 console.log('Balance sheet boxes created successfully');
                 
             } catch (error) {
                 console.error('Error creating balance sheet boxes:', error);
                 document.getElementById('balanceSheetBoxes').innerHTML = `
                     <div class="alert alert-danger">
                         <i class="fas fa-exclamation-triangle"></i>
                         ì¬ë¬´ìƒíƒœí‘œ ë°•ìŠ¤ ìƒì„± ì‹¤íŒ¨: ${error.message}
                     </div>
                 `;
             }
         }

         // ì¬ë¬´ë¹„ìœ¨ ì°¨íŠ¸ ë¡œë“œ
         async function loadRatioCharts(years) {
             try {
                 console.log('Loading ratio charts for years:', years);
                 const response = await fetch(`/api/chart/${corpCode}?type=ratios&years=${years}`);
                 
                 if (!response.ok) {
                     throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                 }
                 
                 const charts = await response.json();
                 console.log('Received ratio charts data:', charts);
                 
                 if (charts.error) {
                     console.error('Ratio chart error:', charts.error);
                     const errorMessage = `
                         <div class="alert alert-warning">
                             <i class="fas fa-exclamation-triangle"></i>
                             ì¬ë¬´ë¹„ìœ¨ ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨: ${charts.error}
                         </div>
                     `;
                     document.getElementById('profitabilityChart').innerHTML = errorMessage;
                     document.getElementById('stabilityChart').innerHTML = errorMessage;
                     document.getElementById('growthChart').innerHTML = errorMessage;
                     document.getElementById('comparisonChart').innerHTML = errorMessage;
                     return;
                 }

                                 // ìˆ˜ìµì„± ë¹„ìœ¨ ì°¨íŠ¸
                if (charts.profitability) {
                    console.log('Creating profitability chart...');
                    document.getElementById('profitabilityChart').innerHTML = ''; // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                    Plotly.newPlot('profitabilityChart', charts.profitability.data, charts.profitability.layout);
                    console.log('Profitability chart created successfully');
                } else {
                     document.getElementById('profitabilityChart').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             ìˆ˜ìµì„± ë¹„ìœ¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                         </div>
                     `;
                 }
                 
                                 // ì•ˆì •ì„± ë¹„ìœ¨ ì°¨íŠ¸
                if (charts.stability) {
                    console.log('Creating stability chart...');
                    document.getElementById('stabilityChart').innerHTML = ''; // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                    Plotly.newPlot('stabilityChart', charts.stability.data, charts.stability.layout);
                    console.log('Stability chart created successfully');
                } else {
                     document.getElementById('stabilityChart').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             ì•ˆì •ì„± ë¹„ìœ¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                         </div>
                     `;
                 }
                 
                                 // ì„±ì¥ì„± ë¹„ìœ¨ ì°¨íŠ¸
                if (charts.growth) {
                    console.log('Creating growth chart...');
                    document.getElementById('growthChart').innerHTML = ''; // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                    Plotly.newPlot('growthChart', charts.growth.data, charts.growth.layout);
                    console.log('Growth chart created successfully');
                } else {
                     document.getElementById('growthChart').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             ì„±ì¥ì„± ë¹„ìœ¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                         </div>
                     `;
                 }
                 
                                 // ì¢…í•© ë¹„ìœ¨ ë¹„êµ ì°¨íŠ¸
                if (charts.comparison) {
                    console.log('Creating comparison chart...');
                    document.getElementById('comparisonChart').innerHTML = ''; // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                    Plotly.newPlot('comparisonChart', charts.comparison.data, charts.comparison.layout);
                    console.log('Comparison chart created successfully');
                } else {
                     document.getElementById('comparisonChart').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             ì¢…í•© ë¹„ìœ¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                         </div>
                     `;
                 }
                 
             } catch (error) {
                 console.error('Error loading ratio charts:', error);
                 const errorMessage = `
                     <div class="alert alert-danger">
                         <i class="fas fa-exclamation-triangle"></i>
                         ì¬ë¬´ë¹„ìœ¨ ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨: ${error.message}
                     </div>
                 `;
                 document.getElementById('profitabilityChart').innerHTML = errorMessage;
                 document.getElementById('stabilityChart').innerHTML = errorMessage;
                 document.getElementById('growthChart').innerHTML = errorMessage;
                 document.getElementById('comparisonChart').innerHTML = errorMessage;
             }
         }

         // ë‹¹ê¸°vsì „ê¸° ë¹„êµ ì°¨íŠ¸ ë¡œë“œ
         async function loadComparisonCharts(years) {
             try {
                 console.log('Loading comparison charts for years:', years);
                 const response = await fetch(`/api/chart/${corpCode}?type=comparison&years=${years}`);
                 
                 if (!response.ok) {
                     throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                 }
                 
                 const charts = await response.json();
                 console.log('Received comparison charts data:', charts);
                 
                 if (charts.error) {
                     console.error('Comparison chart error:', charts.error);
                     const errorMessage = `
                         <div class="alert alert-warning">
                             <i class="fas fa-exclamation-triangle"></i>
                             ë¹„êµ ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨: ${charts.error}
                         </div>
                     `;
                     document.getElementById('incomeComparisonChart').innerHTML = errorMessage;
                     document.getElementById('balanceComparisonChart').innerHTML = errorMessage;
                     document.getElementById('growthAnalysisChart').innerHTML = errorMessage;
                     document.getElementById('comparisonDataTable').innerHTML = errorMessage;
                     return;
                 }

                 // ì†ìµê³„ì‚°ì„œ ë¹„êµ ì°¨íŠ¸
                 if (charts.income_comparison) {
                     console.log('Creating income comparison chart...');
                     document.getElementById('incomeComparisonChart').innerHTML = '';
                     Plotly.newPlot('incomeComparisonChart', charts.income_comparison.data, charts.income_comparison.layout);
                     console.log('Income comparison chart created successfully');
                 } else {
                     document.getElementById('incomeComparisonChart').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             ì†ìµê³„ì‚°ì„œ ë¹„êµ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                         </div>
                     `;
                 }
                 
                 // ì¬ë¬´ìƒíƒœí‘œ ë¹„êµ ì°¨íŠ¸
                 if (charts.balance_comparison) {
                     console.log('Creating balance comparison chart...');
                     document.getElementById('balanceComparisonChart').innerHTML = '';
                     Plotly.newPlot('balanceComparisonChart', charts.balance_comparison.data, charts.balance_comparison.layout);
                     console.log('Balance comparison chart created successfully');
                 } else {
                     document.getElementById('balanceComparisonChart').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             ì¬ë¬´ìƒíƒœí‘œ ë¹„êµ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                         </div>
                     `;
                 }
                 
                 // ì¦ê°ë¥  ë¶„ì„ ì°¨íŠ¸
                 if (charts.growth_analysis) {
                     console.log('Creating growth analysis chart...');
                     document.getElementById('growthAnalysisChart').innerHTML = '';
                     Plotly.newPlot('growthAnalysisChart', charts.growth_analysis.data, charts.growth_analysis.layout);
                     console.log('Growth analysis chart created successfully');
                 } else {
                     document.getElementById('growthAnalysisChart').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             ì¦ê°ë¥  ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                         </div>
                     `;
                 }
                 
                 // ë¹„êµ ë°ì´í„° í…Œì´ë¸”
                 if (charts.comparison_data) {
                     console.log('Creating comparison data table...');
                     document.getElementById('comparisonDataTable').innerHTML = createComparisonTable(charts.comparison_data);
                     console.log('Comparison data table created successfully');
                 } else {
                     document.getElementById('comparisonDataTable').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             ë¹„êµ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                         </div>
                     `;
                 }
                 
             } catch (error) {
                 console.error('Error loading comparison charts:', error);
                 const errorMessage = `
                     <div class="alert alert-danger">
                         <i class="fas fa-exclamation-triangle"></i>
                         ë¹„êµ ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨: ${error.message}
                     </div>
                 `;
                 document.getElementById('incomeComparisonChart').innerHTML = errorMessage;
                 document.getElementById('balanceComparisonChart').innerHTML = errorMessage;
                 document.getElementById('growthAnalysisChart').innerHTML = errorMessage;
                 document.getElementById('comparisonDataTable').innerHTML = errorMessage;
             }
         }

         // ë¹„êµ ë°ì´í„° í…Œì´ë¸” ìƒì„±
         function createComparisonTable(data) {
             let html = `
                 <div class="table-responsive">
                     <table class="table table-striped table-hover">
                         <thead class="table-dark">
                             <tr>
                                 <th>í•­ëª©</th>
                                 <th>${data[0]?.previous_year}ë…„</th>
                                 <th>${data[0]?.current_year}ë…„</th>
                                 <th>ì¦ê°ì•¡</th>
                                 <th>ì¦ê°ë¥ </th>
                             </tr>
                         </thead>
                         <tbody>
             `;
             
             data.forEach(item => {
                 const prevAmount = formatKoreanWon(item.previous_amount);
                 const currAmount = formatKoreanWon(item.current_amount);
                 const diffAmount = formatKoreanWon(Math.abs(item.diff_amount));
                 const growthRate = item.growth_rate;
                 const growthClass = growthRate >= 0 ? 'text-success' : 'text-danger';
                 const growthIcon = growthRate >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                 const diffSign = item.diff_amount >= 0 ? '+' : '-';
                 
                 html += `
                     <tr>
                         <td><strong>${item.item}</strong></td>
                         <td>${prevAmount}</td>
                         <td>${currAmount}</td>
                         <td class="${growthClass}">
                             <i class="fas ${growthIcon}"></i>
                             ${diffSign}${diffAmount}
                         </td>
                         <td class="${growthClass}">
                             <i class="fas ${growthIcon}"></i>
                             ${Math.abs(growthRate).toFixed(1)}%
                         </td>
                     </tr>
                 `;
             });
             
             html += `
                         </tbody>
                     </table>
                 </div>
             `;
             
             return html;
         }

         // AI ë¶„ì„ ë¡œë“œ
         async function loadAIAnalysis(years) {
             try {
                 const yearArray = years.split(',');
                 const latestYear = yearArray[yearArray.length - 1];
                 console.log('Loading AI analysis for years:', years);
                 
                 // AI ì¬ë¬´ì œí‘œ ë¶„ì„ ë¡œë“œ (ê¸°ë³¸ê°’: ìµœì‹ ë…„ë„)
                 loadAIFinancialAnalysis(latestYear);
                 
                 // AI ë¹„êµ ë¶„ì„ ë¡œë“œ
                 loadAIComparisonAnalysis(years);
                 
             } catch (error) {
                 console.error('Error loading AI analysis:', error);
             }
         }



         // AI ì¬ë¬´ì œí‘œ ë¶„ì„ ë¡œë“œ
         async function loadAIFinancialAnalysis(year) {
             if (!year) {
                 document.getElementById('aiAnalysisContent').innerHTML = `
                     <div class="alert alert-info">
                         <i class="fas fa-calendar-alt"></i>
                         ìƒë‹¨ì—ì„œ ì‚¬ì—…ì—°ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.
                     </div>
                 `;
                 return;
             }

             // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
             document.getElementById('aiAnalysisContent').innerHTML = `
                 <div class="loading-chart">
                     <div class="spinner-border text-primary"></div>
                     <p class="mt-3">${year}ë…„ AI ë¶„ì„ ì¤‘...</p>
                 </div>
             `;

             try {
                 const response = await fetch(`/api/ai-analysis/${corpCode}/${year}`);
                 
                 if (!response.ok) {
                     throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                 }
                 
                 const result = await response.json();
                 console.log('Received AI analysis data:', result);
                 
                 if (result.error) {
                     document.getElementById('aiAnalysisContent').innerHTML = `
                         <div class="alert alert-warning">
                             <i class="fas fa-exclamation-triangle"></i>
                             AI ë¶„ì„ ì‹¤íŒ¨: ${result.error}
                         </div>
                     `;
                     return;
                 }
                 
                 if (!result.ai_enabled) {
                     document.getElementById('aiAnalysisContent').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             AI ë¶„ì„ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ Gemini API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.
                             <br><small>.env íŒŒì¼ì— GEMINI_API_KEYë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</small>
                         </div>
                     `;
                     return;
                 }
                 
                 if (result.ai_analysis) {
                     const formattedAnalysis = formatAIAnalysis(result.ai_analysis);
                     document.getElementById('aiAnalysisContent').innerHTML = `
                         <div class="ai-analysis-content">
                             <div class="mb-3">
                                 <span class="badge bg-primary">
                                     <i class="fas fa-robot"></i> ${result.company_name} ${result.year}ë…„ AI ë¶„ì„
                                 </span>
                             </div>
                             ${formattedAnalysis}
                         </div>
                     `;
                 } else {
                     document.getElementById('aiAnalysisContent').innerHTML = `
                         <div class="alert alert-warning">
                             <i class="fas fa-exclamation-triangle"></i>
                             AI ë¶„ì„ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                         </div>
                     `;
                 }
                 
             } catch (error) {
                 console.error('Error loading AI financial analysis:', error);
                 document.getElementById('aiAnalysisContent').innerHTML = `
                     <div class="alert alert-danger">
                         <i class="fas fa-exclamation-triangle"></i>
                         AI ë¶„ì„ ë¡œë”© ì‹¤íŒ¨: ${error.message}
                     </div>
                 `;
             }
                 }

        // ì„ íƒ ì—°ë„ì™€ ì „ë…„ë„ AI ë¹„êµ ë¶„ì„ ì—…ë°ì´íŠ¸
        async function updateAIComparisonWithPreviousYear(selectedYear) {
            const currentYear = parseInt(selectedYear);
            const previousYear = currentYear - 1;
            
            console.log(`AI ë¹„êµ ë¶„ì„ ì—…ë°ì´íŠ¸: ${previousYear}ë…„ vs ${currentYear}ë…„`);
            
            // AI ë¹„êµ ë¶„ì„ í—¤ë” ì—…ë°ì´íŠ¸
            document.getElementById('aiComparisonTitle').innerHTML = `
                <i class="fas fa-chart-line text-success"></i> AI ë¹„êµ ë¶„ì„ 
                <span class="badge bg-success ms-2">${previousYear}ë…„ vs ${currentYear}ë…„</span>
            `;
            
            // AI ë¹„êµ ë¶„ì„ ì„¹ì…˜ì„ ë¡œë”© ìƒíƒœë¡œ ë³€ê²½
            document.getElementById('aiComparisonContent').innerHTML = `
                <div class="loading-chart">
                    <div class="spinner-border text-success"></div>
                    <p class="mt-3">${previousYear}ë…„ vs ${currentYear}ë…„ AI ë¹„êµ ë¶„ì„ ì¤‘...</p>
                </div>
            `;
            
            // ì„ íƒ ì—°ë„ì™€ ì „ë…„ë„ë¡œ ë¹„êµ ë¶„ì„ ì‹¤í–‰
            await loadAIComparisonAnalysis(`${previousYear},${currentYear}`);
        }

        // AI ë¹„êµ ë¶„ì„ ë¡œë“œ
        async function loadAIComparisonAnalysis(years) {
             try {
                 const response = await fetch(`/api/ai-comparison/${corpCode}?years=${years}`);
                 
                 if (!response.ok) {
                     throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                 }
                 
                 const result = await response.json();
                 console.log('Received AI comparison data:', result);
                 
                 if (result.error) {
                     document.getElementById('aiComparisonContent').innerHTML = `
                         <div class="alert alert-warning">
                             <i class="fas fa-exclamation-triangle"></i>
                             AI ë¹„êµ ë¶„ì„ ì‹¤íŒ¨: ${result.error}
                         </div>
                     `;
                     return;
                 }
                 
                 if (!result.ai_enabled) {
                     document.getElementById('aiComparisonContent').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             AI ë¶„ì„ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ Gemini API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.
                         </div>
                     `;
                     return;
                 }
                 
                 if (result.ai_analysis) {
                     const formattedAnalysis = formatAIAnalysis(result.ai_analysis);
                     document.getElementById('aiComparisonContent').innerHTML = `
                         <div class="ai-analysis-content">
                             <div class="mb-3">
                                 <span class="badge bg-success">
                                     <i class="fas fa-chart-line"></i> ${result.company_name} ${result.previous_year} vs ${result.current_year} AI ë¹„êµë¶„ì„
                                 </span>
                             </div>
                             ${formattedAnalysis}
                         </div>
                     `;
                 } else {
                     document.getElementById('aiComparisonContent').innerHTML = `
                         <div class="alert alert-warning">
                             <i class="fas fa-exclamation-triangle"></i>
                             AI ë¹„êµ ë¶„ì„ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                         </div>
                     `;
                 }
                 
             } catch (error) {
                 console.error('Error loading AI comparison analysis:', error);
                 document.getElementById('aiComparisonContent').innerHTML = `
                     <div class="alert alert-danger">
                         <i class="fas fa-exclamation-triangle"></i>
                         AI ë¹„êµ ë¶„ì„ ë¡œë”© ì‹¤íŒ¨: ${error.message}
                     </div>
                 `;
             }
         }

         // AI ë¶„ì„ ê²°ê³¼ í¬ë§·íŒ…
         function formatAIAnalysis(analysisText) {
             if (!analysisText) return '';
             
             // ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ í—¤ë”©ì„ HTMLë¡œ ë³€í™˜
             let formatted = analysisText
                 .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                 .replace(/^(\d+\.\s*\*\*.*?\*\*)/gm, '<h6 class="mt-3 text-primary">$1</h6>')
                 .replace(/\n\n/g, '</p><p>')
                 .replace(/\n/g, '<br>');
             
             // ì´ëª¨ì§€ì™€ í•¨ê»˜ ì„¹ì…˜ êµ¬ë¶„
             formatted = formatted
                 .replace(/ğŸ“Š/g, '<i class="fas fa-chart-bar text-info"></i>')
                 .replace(/ğŸ’°/g, '<i class="fas fa-coins text-warning"></i>')
                 .replace(/ğŸ¦/g, '<i class="fas fa-university text-primary"></i>')
                 .replace(/ğŸ“ˆ/g, '<i class="fas fa-chart-line text-success"></i>')
                 .replace(/âš ï¸/g, '<i class="fas fa-exclamation-triangle text-warning"></i>')
                 .replace(/ğŸ¯/g, '<i class="fas fa-bullseye text-danger"></i>')
                 .replace(/ğŸ“‰/g, '<i class="fas fa-chart-line-down text-danger"></i>')
                 .replace(/ğŸ”/g, '<i class="fas fa-search text-info"></i>');
             
             return `<div class="ai-analysis-text">${formatted}</div>`;
         }

         // íƒ­ ì „í™˜ ì‹œ ì°¨íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ
        document.addEventListener('shown.bs.tab', function (event) {
            setTimeout(() => {
                Plotly.Plots.resize('revenueChart');
                Plotly.Plots.resize('profitChart');
                Plotly.Plots.resize('assetsChart');
                Plotly.Plots.resize('debtEquityChart');
                Plotly.Plots.resize('profitabilityChart');
                Plotly.Plots.resize('stabilityChart');
                Plotly.Plots.resize('growthChart');
                Plotly.Plots.resize('comparisonChart');
                Plotly.Plots.resize('incomeComparisonChart');
                Plotly.Plots.resize('balanceComparisonChart');
                Plotly.Plots.resize('growthAnalysisChart');
            }, 100);
        });
    </script>
</body>
</html> 