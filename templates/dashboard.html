<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä {{ company.corp_name }} - Ïû¨Î¨¥Ï†úÌëú ÎåÄÏãúÎ≥¥Îìú</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .ai-analysis-content {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            max-height: 500px;
            overflow-y: auto;
        }

        .ai-analysis-text {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }

        .ai-analysis-text h6 {
            margin-top: 15px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .ai-analysis-text strong {
            color: #007bff;
            font-weight: 600;
        }

                 .ai-analysis-text .fas {
             margin-right: 5px;
         }

         .ai-year-select {
             min-width: 100px;
             font-size: 13px;
         }

         .chart-container .d-flex h4 {
             color: #495057;
         }

         /* Ïû¨Î¨¥ÏÉÅÌÉúÌëú Î∞ïÏä§ ÏãúÍ∞ÅÌôî Ïä§ÌÉÄÏùº - 3Î∂ÑÌï† Íµ¨Ï°∞ */
         .balance-sheet-container {
             display: flex;
             justify-content: center;
             align-items: center;
             padding: 20px;
             min-height: 400px;
             background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
             border-radius: 12px;
             margin: 20px 0;
         }

         .single-balance-box {
             position: relative;
             border-radius: 8px;
             box-shadow: 0 4px 15px rgba(0,0,0,0.1);
             transition: all 0.3s ease;
             display: flex;
             width: 600px;
             height: 300px;
             background: white;
             overflow: hidden;
         }

         .single-balance-box:hover {
             transform: translateY(-3px);
             box-shadow: 0 8px 25px rgba(0,0,0,0.15);
         }

         .assets-section {
             flex: 1;
             background: linear-gradient(180deg, #28a745 0%, #20c997 100%);
             color: white;
             display: flex;
             flex-direction: column;
             position: relative;
         }

         .liabilities-equity-section {
             flex: 1;
             display: flex;
             flex-direction: column;
         }

         .liability-section {
             flex: 1;
             background: linear-gradient(180deg, #dc3545 0%, #fd7e14 100%);
             color: white;
             display: flex;
             flex-direction: column;
             border-bottom: 2px solid rgba(255,255,255,0.3);
         }

         .equity-section {
             flex: 1;
             background: linear-gradient(180deg, #6f42c1 0%, #e83e8c 100%);
             color: white;
             display: flex;
             flex-direction: column;
         }

         .section-title {
             text-align: center;
             padding: 8px 0;
             font-weight: bold;
             font-size: 16px;
             margin-bottom: 10px;
         }
         
         .section-title i {
             margin-right: 6px;
         }

         .section-content {
             padding: 15px;
             text-align: center;
             flex: 1;
             display: flex;
             flex-direction: column;
             justify-content: center;
             position: relative;
         }
         
         .ratio-display {
             position: absolute;
             bottom: 8px;
             right: 12px;
             font-size: 10px;
             opacity: 0.8;
             font-weight: bold;
             background: rgba(0,0,0,0.2);
             padding: 2px 6px;
             border-radius: 10px;
         }

         .amount-display {
             font-size: 18px;
             font-weight: bold;
             margin: 8px 0;
             text-shadow: 0 2px 4px rgba(0,0,0,0.3);
         }

         .amount-label {
             font-size: 12px;
             opacity: 0.9;
             margin-bottom: 5px;
         }

         .assets-section .amount-display {
             font-size: 24px;
         }

         .assets-section .section-title {
             font-size: 20px;
             padding: 12px 0;
         }

         .balance-divider {
             width: 2px;
             background: rgba(0,0,0,0.1);
         }

         @media (max-width: 768px) {
             .single-balance-box {
                 width: 100%;
                 max-width: 500px;
                 height: 250px;
             }
             
             .amount-display {
                 font-size: 16px;
             }
             
             .assets-section .amount-display {
                 font-size: 20px;
             }
             
             .section-title {
                 font-size: 14px;
             }
             
             .assets-section .section-title {
                 font-size: 16px;
             }
             
             .ratio-display {
                 font-size: 9px;
                 bottom: 6px;
                 right: 8px;
             }
         }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        
        .company-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.2s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .metric-change {
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        
        .nav-pills .nav-link {
            border-radius: 25px;
            padding: 10px 20px;
            margin: 0 5px;
            font-weight: 600;
        }
        
        .nav-pills .nav-link.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }
        
        .loading-chart {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        
        .btn-back {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 25px;
            padding: 10px 20px;
            transition: all 0.3s ease;
        }
        
        .btn-back:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            transform: translateY(-2px);
        }
        
        .stock-info {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-left: 15px;
        }
        
        .year-selector {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <div class="header-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="company-info">
                        <h1 class="mb-3">
                            <i class="fas fa-building"></i> {{ company.corp_name }}
                            {% if company.stock_code %}
                                <span class="stock-info">
                                    <i class="fas fa-chart-line"></i> {{ company.stock_code }}
                                </span>
                            {% else %}
                                <span class="stock-info">
                                    <i class="fas fa-info-circle"></i> ÎπÑÏÉÅÏû•
                                </span>
                            {% endif %}
                        </h1>
                        <p class="mb-2">
                            <i class="fas fa-barcode"></i> Í∏∞ÏóÖÏΩîÎìú: {{ company.corp_code }}
                        </p>
                        <p class="mb-0">
                            <i class="fas fa-calendar"></i> ÏµúÏ¢Ö ÏàòÏ†ï: {{ company.modify_date }}
                        </p>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/" class="btn btn-back">
                        <i class="fas fa-arrow-left"></i> Í≤ÄÏÉâÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Year and Report Type Selector -->
        <div class="year-selector">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt"></i> Ï°∞Ìöå Ï°∞Í±¥ ÏÑ†ÌÉù
                    </h5>
                </div>
                <div class="col-md-9">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="specificYear" class="form-label mb-1">üìÖ ÏÇ¨ÏóÖÏó∞ÎèÑ</label>
                            <select id="specificYear" class="form-select" onchange="updateSpecificData()">
                                <option value="">Ïó∞ÎèÑ ÏÑ†ÌÉù</option>
                                <option value="2024">2024ÎÖÑ</option>
                                <option value="2023" selected>2023ÎÖÑ</option>
                                <option value="2022">2022ÎÖÑ</option>
                                <option value="2021">2021ÎÖÑ</option>
                                <option value="2020">2020ÎÖÑ</option>
                                <option value="2019">2019ÎÖÑ</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="reportType" class="form-label mb-1">üìä Î≥¥Í≥†ÏÑú Ïú†Ìòï</label>
                            <select id="reportType" class="form-select" onchange="updateSpecificData()">
                                <option value="11011" selected>ÏÇ¨ÏóÖÎ≥¥Í≥†ÏÑú (Ïó∞Í∞Ñ)</option>
                                <option value="11014">3Î∂ÑÍ∏∞Î≥¥Í≥†ÏÑú</option>
                                <option value="11012">Î∞òÍ∏∞Î≥¥Í≥†ÏÑú</option>
                                <option value="11013">1Î∂ÑÍ∏∞Î≥¥Í≥†ÏÑú</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="yearRange" class="form-label mb-1">üìà Ï∂îÏÑ∏Î∂ÑÏÑù Î≤îÏúÑ</label>
                            <select id="yearRange" class="form-select" onchange="updateCharts()">
                                <option value="2021,2022,2023">2021-2023 (3ÎÖÑ)</option>
                                <option value="2020,2021,2022,2023">2020-2023 (4ÎÖÑ)</option>
                                <option value="2019,2020,2021,2022,2023">2019-2023 (5ÎÖÑ)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Metrics -->
        <div id="metricsSection">
            <div class="loading-chart">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</span>
                </div>
                <p class="mt-3">Ïû¨Î¨¥ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...</p>
            </div>
        </div>

        <!-- Chart Navigation -->
        <ul class="nav nav-pills justify-content-center mb-4" id="chartTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="trend-tab" data-bs-toggle="pill" 
                        data-bs-target="#trend-pane" type="button" role="tab">
                    <i class="fas fa-chart-line"></i> Ï∂îÏÑ∏ Î∂ÑÏÑù
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="structure-tab" data-bs-toggle="pill" 
                        data-bs-target="#structure-pane" type="button" role="tab">
                    <i class="fas fa-chart-pie"></i> Íµ¨Ï°∞ Î∂ÑÏÑù
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ratios-tab" data-bs-toggle="pill" 
                        data-bs-target="#ratios-pane" type="button" role="tab">
                    <i class="fas fa-calculator"></i> Ïû¨Î¨¥ÎπÑÏú®
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="comparison-tab" data-bs-toggle="pill" 
                        data-bs-target="#comparison-pane" type="button" role="tab">
                    <i class="fas fa-balance-scale"></i> ÎãπÍ∏∞vsÏ†ÑÍ∏∞ ÎπÑÍµê
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ai-analysis-tab" data-bs-toggle="pill" 
                        data-bs-target="#ai-analysis-pane" type="button" role="tab">
                    <i class="fas fa-robot"></i> AI Î∂ÑÏÑù
                </button>
            </li>
        </ul>

        <!-- Chart Content -->
        <div class="tab-content" id="chartContent">
            <!-- Trend Analysis Tab -->
            <div class="tab-pane fade show active" id="trend-pane" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-chart-line text-primary"></i> Îß§Ï∂úÏï° Ï∂îÏÑ∏
                            </h4>
                            <div id="revenueChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="mt-3">Ï∞®Ìä∏ ÏÉùÏÑ± Ï§ë...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-chart-line text-success"></i> ÏàúÏù¥Ïùµ Ï∂îÏÑ∏
                            </h4>
                            <div id="profitChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-success"></div>
                                    <p class="mt-3">Ï∞®Ìä∏ ÏÉùÏÑ± Ï§ë...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Structure Analysis Tab -->
            <div class="tab-pane fade" id="structure-pane" role="tabpanel">
                <!-- Ïû¨Î¨¥ÏÉÅÌÉúÌëú Î∞ïÏä§ ÏãúÍ∞ÅÌôî -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="chart-container">
                            <h4 class="mb-3 text-center">
                                <i class="fas fa-building text-primary"></i> Ïû¨Î¨¥ÏÉÅÌÉúÌëú Íµ¨Ï°∞
                            </h4>
                            <div id="balanceSheetBoxes">
                                <div class="loading-chart">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="mt-3">Ïû¨Î¨¥ÏÉÅÌÉúÌëú Î∞ïÏä§ ÏÉùÏÑ± Ï§ë...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Í∏∞Ï°¥ Ï∞®Ìä∏Îì§ -->
                <div class="row">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-chart-pie text-info"></i> ÏûêÏÇ∞ Íµ¨Ï°∞
                            </h4>
                            <div id="assetsChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-info"></div>
                                    <p class="mt-3">Ï∞®Ìä∏ ÏÉùÏÑ± Ï§ë...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-chart-bar text-warning"></i> ÏûêÎ≥∏ vs Î∂ÄÏ±Ñ
                            </h4>
                            <div id="debtEquityChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-warning"></div>
                                    <p class="mt-3">Ï∞®Ìä∏ ÏÉùÏÑ± Ï§ë...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Ratios Tab -->
            <div class="tab-pane fade" id="ratios-pane" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-chart-line text-success"></i> ÏàòÏùµÏÑ± ÎπÑÏú®
                            </h4>
                            <div id="profitabilityChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-success"></div>
                                    <p class="mt-3">Ï∞®Ìä∏ ÏÉùÏÑ± Ï§ë...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-shield-alt text-primary"></i> ÏïàÏ†ïÏÑ± ÎπÑÏú®
                            </h4>
                            <div id="stabilityChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="mt-3">Ï∞®Ìä∏ ÏÉùÏÑ± Ï§ë...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-seedling text-info"></i> ÏÑ±Ïû•ÏÑ± ÎπÑÏú®
                            </h4>
                            <div id="growthChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-info"></div>
                                    <p class="mt-3">Ï∞®Ìä∏ ÏÉùÏÑ± Ï§ë...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-radar-chart text-warning"></i> Ï¢ÖÌï© ÎπÑÏú® Î∂ÑÏÑù
                            </h4>
                            <div id="comparisonChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-warning"></div>
                                    <p class="mt-3">Ï∞®Ìä∏ ÏÉùÏÑ± Ï§ë...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comparison Tab -->
            <div class="tab-pane fade" id="comparison-pane" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-chart-bar text-primary"></i> ÏÜêÏùµÍ≥ÑÏÇ∞ÏÑú ÎπÑÍµê
                            </h4>
                            <div id="incomeComparisonChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="mt-3">Ï∞®Ìä∏ ÏÉùÏÑ± Ï§ë...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-chart-bar text-success"></i> Ïû¨Î¨¥ÏÉÅÌÉúÌëú ÎπÑÍµê
                            </h4>
                            <div id="balanceComparisonChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-success"></div>
                                    <p class="mt-3">Ï∞®Ìä∏ ÏÉùÏÑ± Ï§ë...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-chart-line text-warning"></i> Ï¶ùÍ∞êÎ•† Î∂ÑÏÑù
                            </h4>
                            <div id="growthAnalysisChart">
                                <div class="loading-chart">
                                    <div class="spinner-border text-warning"></div>
                                    <p class="mt-3">Ï∞®Ìä∏ ÏÉùÏÑ± Ï§ë...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-table text-info"></i> ÏÉÅÏÑ∏ ÎπÑÍµê Îç∞Ïù¥ÌÑ∞
                            </h4>
                            <div id="comparisonDataTable">
                                <div class="loading-chart">
                                    <div class="spinner-border text-info"></div>
                                    <p class="mt-3">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Analysis Tab -->
            <div class="tab-pane fade" id="ai-analysis-pane" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3">
                                <i class="fas fa-robot text-primary"></i> AI Ïû¨Î¨¥Ï†úÌëú Î∂ÑÏÑù
                            </h4>
                            <div id="aiAnalysisContent">
                                <div class="loading-chart">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="mt-3">AI Î∂ÑÏÑù Ï§ë...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h4 class="mb-3" id="aiComparisonTitle">
                                <i class="fas fa-chart-line text-success"></i> AI ÎπÑÍµê Î∂ÑÏÑù
                            </h4>
                            <div id="aiComparisonContent">
                                <div class="loading-chart">
                                    <div class="spinner-border text-success"></div>
                                    <p class="mt-3">AI ÎπÑÍµê Î∂ÑÏÑù Ï§ë...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const corpCode = '{{ corp_code }}';
        let currentFinancialData = null;

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, checking Plotly...');
            
            // Plotly ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏóàÎäîÏßÄ ÌôïÏù∏
            if (typeof Plotly === 'undefined') {
                console.error('Plotly library not loaded!');
                document.getElementById('revenueChart').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Plotly ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§. Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.
                    </div>
                `;
                document.getElementById('profitChart').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Plotly ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§. Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.
                    </div>
                `;
                return;
            }
            
            console.log('Plotly loaded successfully');
            loadLatestFinancialData();
            updateCharts();
            
            // Ï¥àÍ∏∞ Î∂ÑÏÑùÏó∞ÎèÑÏóê Îî∞Î•∏ AI Î∂ÑÏÑù Î°úÎìú
            const initialYear = document.getElementById('specificYear').value || '2023';
            loadAIFinancialAnalysis(initialYear);
            updateAIComparisonWithPreviousYear(initialYear);
        });

        // ÏµúÏã† Ïû¨Î¨¥ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Î©îÌä∏Î¶≠ ÌëúÏãúÏö©)
        async function loadLatestFinancialData() {
            const year = document.getElementById('specificYear').value || '2023';
            const reportType = document.getElementById('reportType').value || '11011';
            
            try {
                const response = await fetch(`/api/financial/${corpCode}/${year}?reprt_code=${reportType}`);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('metricsSection').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${year}ÎÖÑ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. Îã§Î•∏ Ïó∞ÎèÑÎÇò Î≥¥Í≥†ÏÑú Ïú†ÌòïÏùÑ ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî.
                        </div>
                    `;
                    return;
                }

                currentFinancialData = data;
                displayMetrics(data);
                
            } catch (error) {
                console.error('Error loading financial data:', error);
                document.getElementById('metricsSection').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.
                    </div>
                `;
            }
        }

        // Í∞úÎ≥Ñ ÏÇ¨ÏóÖÏó∞ÎèÑ/Î≥¥Í≥†ÏÑú Ïú†Ìòï Î≥ÄÍ≤ΩÏãú Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        async function updateSpecificData() {
            const year = document.getElementById('specificYear').value;
            const reportType = document.getElementById('reportType').value;
            
            if (!year) {
                document.getElementById('metricsSection').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-calendar-alt"></i>
                        ÏÇ¨ÏóÖÏó∞ÎèÑÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.
                    </div>
                `;
                return;
            }
            
            console.log(`ÏÇ¨ÏóÖÏó∞ÎèÑ: ${year}, Î≥¥Í≥†ÏÑú Ïú†Ìòï: ${reportType}Î°ú Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë...`);
            
            // Î©îÌä∏Î¶≠ ÏÑπÏÖò Î°úÎî© ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤Ω
            document.getElementById('metricsSection').innerHTML = `
                <div class="loading-chart">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</span>
                    </div>
                    <p class="mt-3">${year}ÎÖÑ ${getReportTypeName(reportType)} Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
                </div>
            `;
            
            // Î©îÌä∏Î¶≠ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°ú Î°úÎìú
            await loadLatestFinancialData();
            
            // AI Ïû¨Î¨¥Ï†úÌëú Î∂ÑÏÑù ÏóÖÎç∞Ïù¥Ìä∏ (Ìï≠ÏÉÅ ÏÑ†ÌÉù Ïó∞ÎèÑÎ°ú ÏóÖÎç∞Ïù¥Ìä∏)
            loadAIFinancialAnalysis(year);
            
            // AI ÎπÑÍµê Î∂ÑÏÑù ÏóÖÎç∞Ïù¥Ìä∏ (ÏÑ†ÌÉù Ïó∞ÎèÑ vs Ï†ÑÎÖÑÎèÑ)
            await updateAIComparisonWithPreviousYear(year);
            
            // Íµ¨Ï°∞ Î∂ÑÏÑù ÏóÖÎç∞Ïù¥Ìä∏ (Ïû¨Î¨¥ÏÉÅÌÉúÌëú Î∞ïÏä§ Ìè¨Ìï®)
            loadStructureCharts();
        }

        // Î≥¥Í≥†ÏÑú Ïú†Ìòï ÏΩîÎìúÎ•º Ïù¥Î¶ÑÏúºÎ°ú Î≥ÄÌôò
        function getReportTypeName(reportCode) {
            const reportNames = {
                '11011': 'ÏÇ¨ÏóÖÎ≥¥Í≥†ÏÑú',
                '11012': 'Î∞òÍ∏∞Î≥¥Í≥†ÏÑú', 
                '11013': '1Î∂ÑÍ∏∞Î≥¥Í≥†ÏÑú',
                '11014': '3Î∂ÑÍ∏∞Î≥¥Í≥†ÏÑú'
            };
            return reportNames[reportCode] || 'Î≥¥Í≥†ÏÑú';
        }

        // Ï£ºÏöî ÏßÄÌëú ÌëúÏãú
        function displayMetrics(data) {
            const rawData = data.raw_data || [];
            
            // Ï£ºÏöî ÏßÄÌëú Ï∂îÏ∂ú
            const metrics = {
                revenue: findMetric(rawData, 'Îß§Ï∂úÏï°', 'IS'),
                profit: findMetric(rawData, 'ÎãπÍ∏∞ÏàúÏù¥Ïùµ', 'IS'),
                assets: findMetric(rawData, 'ÏûêÏÇ∞Ï¥ùÍ≥Ñ', 'BS'),
                equity: findMetric(rawData, 'ÏûêÎ≥∏Ï¥ùÍ≥Ñ', 'BS')
            };

            let html = '<div class="row">';
            
            if (metrics.revenue) {
                html += createMetricCard('Îß§Ï∂úÏï°', metrics.revenue, 'fa-chart-line', 'primary');
            }
            if (metrics.profit) {
                html += createMetricCard('ÏàúÏù¥Ïùµ', metrics.profit, 'fa-coins', 'success');
            }
            if (metrics.assets) {
                html += createMetricCard('ÏûêÏÇ∞Ï¥ùÍ≥Ñ', metrics.assets, 'fa-building', 'info');
            }
            if (metrics.equity) {
                html += createMetricCard('ÏûêÎ≥∏Ï¥ùÍ≥Ñ', metrics.equity, 'fa-piggy-bank', 'warning');
            }
            
            html += '</div>';
            
            document.getElementById('metricsSection').innerHTML = html;
        }

        // ÏßÄÌëú Ï∞æÍ∏∞ Ìó¨Ìçº Ìï®Ïàò
        function findMetric(rawData, accountName, sjDiv) {
            for (const item of rawData) {
                if (item.account_name.includes(accountName) && item.sj_div === sjDiv) {
                    return item;
                }
            }
            return null;
        }

        // Î©îÌä∏Î¶≠ Ïπ¥Îìú ÏÉùÏÑ±
        function createMetricCard(title, metric, icon, color) {
            const currentAmount = metric.current_year.amount;
            const previousAmount = metric.previous_year.amount;
            const change = previousAmount > 0 ? ((currentAmount - previousAmount) / previousAmount * 100) : 0;
            const changeClass = change >= 0 ? 'positive' : 'negative';
            const changeIcon = change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            
            return `
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card">
                        <div class="text-${color} mb-2">
                            <i class="fas ${icon} fa-2x"></i>
                        </div>
                        <div class="metric-value">
                            ${formatKoreanWon(currentAmount)}
                        </div>
                        <div class="metric-label">${title}</div>
                        <div class="metric-change ${changeClass}">
                            <i class="fas ${changeIcon}"></i>
                            ${Math.abs(change).toFixed(1)}%
                        </div>
                    </div>
                </div>
            `;
        }

        // ÌïúÍµ≠ ÏõêÌôî ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
        function formatKoreanWon(amount) {
            const trillion = Math.floor(amount / 1_000_000_000_000);
            const billion = Math.floor((amount % 1_000_000_000_000) / 1_000_000_000);
            
            if (trillion > 0) {
                if (billion > 0) {
                    return `${trillion}.${Math.floor(billion/100)}Ï°∞Ïõê`;
                } else {
                    return `${trillion}Ï°∞Ïõê`;
                }
            } else if (billion > 0) {
                return `${billion.toLocaleString()}ÏñµÏõê`;
            } else {
                return `${Math.floor(amount / 100_000_000).toLocaleString()}ÏñµÏõê`;
            }
        }

        // Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
        async function updateCharts() {
            const yearRange = document.getElementById('yearRange').value;
            
            // Ï∂îÏÑ∏ Ï∞®Ìä∏ Î°úÎìú
            loadTrendCharts(yearRange);
            
            // Íµ¨Ï°∞ Ï∞®Ìä∏ Î°úÎìú
            loadStructureCharts();
            
            // Ïû¨Î¨¥ÎπÑÏú® Ï∞®Ìä∏ Î°úÎìú
            loadRatioCharts(yearRange);
            
            // ÎãπÍ∏∞vsÏ†ÑÍ∏∞ ÎπÑÍµê Ï∞®Ìä∏ Î°úÎìú
            loadComparisonCharts(yearRange);
            
            // AI Î∂ÑÏÑù Î°úÎìú
            loadAIAnalysis(yearRange);
        }

        // Ï∂îÏÑ∏ Ï∞®Ìä∏ Î°úÎìú
        async function loadTrendCharts(years) {
            try {
                console.log('Loading trend charts for years:', years);
                const response = await fetch(`/api/chart/${corpCode}?type=trend&years=${years}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const charts = await response.json();
                console.log('Received charts data:', charts);
                
                if (charts.error) {
                    console.error('Chart error:', charts.error);
                    document.getElementById('revenueChart').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Îß§Ï∂úÏï° Ï∞®Ìä∏ ÏÉùÏÑ± Ïã§Ìå®: ${charts.error}
                        </div>
                    `;
                    document.getElementById('profitChart').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            ÏàúÏù¥Ïùµ Ï∞®Ìä∏ ÏÉùÏÑ± Ïã§Ìå®: ${charts.error}
                        </div>
                    `;
                    return;
                }

                if (charts.revenue_trend) {
                    console.log('Creating revenue chart...');
                    document.getElementById('revenueChart').innerHTML = ''; // Î°úÎî© Î©îÏãúÏßÄ Ï†úÍ±∞
                    Plotly.newPlot('revenueChart', charts.revenue_trend.data, charts.revenue_trend.layout);
                    console.log('Revenue chart created successfully');
                } else {
                    document.getElementById('revenueChart').innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            Îß§Ï∂úÏï° Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                        </div>
                    `;
                }
                
                if (charts.profit_trend) {
                    console.log('Creating profit chart...');
                    document.getElementById('profitChart').innerHTML = ''; // Î°úÎî© Î©îÏãúÏßÄ Ï†úÍ±∞
                    Plotly.newPlot('profitChart', charts.profit_trend.data, charts.profit_trend.layout);
                    console.log('Profit chart created successfully');
                } else {
                    document.getElementById('profitChart').innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            ÏàúÏù¥Ïùµ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading trend charts:', error);
                document.getElementById('revenueChart').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Îß§Ï∂úÏï° Ï∞®Ìä∏ Î°úÎî© Ïã§Ìå®: ${error.message}
                    </div>
                `;
                document.getElementById('profitChart').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        ÏàúÏù¥Ïùµ Ï∞®Ìä∏ Î°úÎî© Ïã§Ìå®: ${error.message}
                    </div>
                `;
            }
        }

        // Íµ¨Ï°∞ Ï∞®Ìä∏ Î°úÎìú
        async function loadStructureCharts() {
            try {
                console.log('Loading structure charts...');
                const response = await fetch(`/api/chart/${corpCode}?type=structure`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const charts = await response.json();
                console.log('Received structure charts data:', charts);
                
                if (charts.error) {
                    console.error('Chart error:', charts.error);
                    document.getElementById('assetsChart').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            ÏûêÏÇ∞Íµ¨Ï°∞ Ï∞®Ìä∏ ÏÉùÏÑ± Ïã§Ìå®: ${charts.error}
                        </div>
                    `;
                    document.getElementById('debtEquityChart').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            ÏûêÎ≥∏vsÎ∂ÄÏ±Ñ Ï∞®Ìä∏ ÏÉùÏÑ± Ïã§Ìå®: ${charts.error}
                        </div>
                    `;
                    return;
                }

                if (charts.assets_structure) {
                    console.log('Creating assets chart...');
                    document.getElementById('assetsChart').innerHTML = ''; // Î°úÎî© Î©îÏãúÏßÄ Ï†úÍ±∞
                    Plotly.newPlot('assetsChart', charts.assets_structure.data, charts.assets_structure.layout);
                    console.log('Assets chart created successfully');
                } else {
                    document.getElementById('assetsChart').innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            ÏûêÏÇ∞Íµ¨Ï°∞ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                        </div>
                    `;
                }
                
                if (charts.debt_equity) {
                    console.log('Creating debt-equity chart...');
                    document.getElementById('debtEquityChart').innerHTML = ''; // Î°úÎî© Î©îÏãúÏßÄ Ï†úÍ±∞
                    Plotly.newPlot('debtEquityChart', charts.debt_equity.data, charts.debt_equity.layout);
                    console.log('Debt-equity chart created successfully');
                } else {
                    document.getElementById('debtEquityChart').innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            ÏûêÎ≥∏vsÎ∂ÄÏ±Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                        </div>
                    `;
                }
                
                // Ïû¨Î¨¥ÏÉÅÌÉúÌëú Î∞ïÏä§ ÏÉùÏÑ±
                createBalanceSheetBoxes();
                
            } catch (error) {
                console.error('Error loading structure charts:', error);
                document.getElementById('assetsChart').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        ÏûêÏÇ∞Íµ¨Ï°∞ Ï∞®Ìä∏ Î°úÎî© Ïã§Ìå®: ${error.message}
                    </div>
                `;
                document.getElementById('debtEquityChart').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        ÏûêÎ≥∏vsÎ∂ÄÏ±Ñ Ï∞®Ìä∏ Î°úÎî© Ïã§Ìå®: ${error.message}
                    </div>
                                 `;
                
                // ÏóêÎü¨ ÏãúÏóêÎèÑ Ïû¨Î¨¥ÏÉÅÌÉúÌëú Î∞ïÏä§ ÏÉùÏÑ± ÏãúÎèÑ
                createBalanceSheetBoxes();
             }
         }

         // Ïû¨Î¨¥ÏÉÅÌÉúÌëú Î∞ïÏä§ ÏãúÍ∞ÅÌôî ÏÉùÏÑ±
         async function createBalanceSheetBoxes() {
             try {
                 console.log('Creating balance sheet boxes...');
                 
                 // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Ïó∞ÎèÑÏùò Ïû¨Î¨¥Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
                 const year = document.getElementById('specificYear').value || '2023';
                 const reportType = document.getElementById('reportType').value || '11011';
                 
                 const response = await fetch(`/api/financial/${corpCode}/${year}?reprt_code=${reportType}`);
                 const data = await response.json();
                 
                 if (data.error) {
                     document.getElementById('balanceSheetBoxes').innerHTML = `
                         <div class="alert alert-warning">
                             <i class="fas fa-exclamation-triangle"></i>
                             Ïû¨Î¨¥ÏÉÅÌÉúÌëú Î∞ïÏä§ ÏÉùÏÑ± Ïã§Ìå®: ${data.error}
                         </div>
                     `;
                     return;
                 }
                 
                 // Ïû¨Î¨¥ÏÉÅÌÉúÌëú Ï£ºÏöî Ìï≠Î™© Ï∂îÏ∂ú (Ïò¨Î∞îÎ•∏ Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÏÇ¨Ïö©)
                 console.log('Balance Sheet Data:', data.balance_sheet);
                 
                 // Ïã§Ï†ú API ÏùëÎãµ Íµ¨Ï°∞Ïóê ÎßûÍ≤å Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
                 const assets = data.balance_sheet?.assets?.ÏûêÏÇ∞Ï¥ùÍ≥Ñ?.current_year?.amount || 
                               data.balance_sheet?.assets?.ÏûêÏÇ∞?.current_year?.amount || 0;
                               
                 const liabilities = data.balance_sheet?.liabilities?.Î∂ÄÏ±ÑÏ¥ùÍ≥Ñ?.current_year?.amount || 
                                   data.balance_sheet?.liabilities?.Î∂ÄÏ±Ñ?.current_year?.amount || 0;
                                   
                 const equity = data.balance_sheet?.equity?.ÏûêÎ≥∏Ï¥ùÍ≥Ñ?.current_year?.amount || 
                               data.balance_sheet?.equity?.ÏûêÎ≥∏?.current_year?.amount || 
                               (assets - liabilities);
                               
                 console.log('Extracted values:', { assets, liabilities, equity });
                 
                 // Ï¥ùÍ≥Ñ Í≥ÑÏÇ∞
                 const total = assets;
                 
                 // ÎπÑÏú® Í≥ÑÏÇ∞
                 const assetsRatio = total > 0 ? ((assets / total) * 100).toFixed(1) : 0;
                 const liabilitiesRatio = total > 0 ? ((liabilities / total) * 100).toFixed(1) : 0;
                 const equityRatio = total > 0 ? ((equity / total) * 100).toFixed(1) : 0;
                 
                 // Ïà´Ïûê Ìè¨Îß∑ÌåÖ Ìï®Ïàò
                 function formatAmount(amount) {
                     if (amount >= 1000000000000) return (amount / 1000000000000).toFixed(1) + 'Ï°∞Ïõê';
                     if (amount >= 100000000) return (amount / 100000000).toFixed(1) + 'ÏñµÏõê';
                     if (amount >= 10000) return (amount / 10000).toFixed(1) + 'ÎßåÏõê';
                     return amount.toLocaleString() + 'Ïõê';
                 }
                 
                 // 3Î∂ÑÌï† Î∞ïÏä§ HTML ÏÉùÏÑ± (Í∞úÏÑ†Îêú Íµ¨Ï°∞)
                 const boxesHTML = `
                     <div class="balance-sheet-container">
                         <div class="single-balance-box">
                             <!-- ÏôºÏ™Ω: ÏûêÏÇ∞ ÏÑπÏÖò -->
                             <div class="assets-section">
                                 <div class="section-content">
                                     <div class="section-title">
                                         <i class="fas fa-building"></i> ÏûêÏÇ∞
                                     </div>
                                     <div class="amount-display">${formatAmount(assets)}</div>
                                     <div class="amount-label">${year}ÎÖÑ Í∏∞Ï§Ä</div>
                                     <div class="ratio-display">${assetsRatio}%</div>
                                 </div>
                             </div>
                             
                             <!-- Í∞ÄÏö¥Îç∞ Íµ¨Î∂ÑÏÑ† -->
                             <div class="balance-divider"></div>
                             
                             <!-- Ïò§Î•∏Ï™Ω: Î∂ÄÏ±Ñ + ÏûêÎ≥∏ ÏÑπÏÖò -->
                             <div class="liabilities-equity-section">
                                 <!-- ÏÉÅÎã®: Î∂ÄÏ±Ñ ÏÑπÏÖò -->
                                 <div class="liability-section">
                                     <div class="section-content">
                                         <div class="section-title">
                                             <i class="fas fa-credit-card"></i> Î∂ÄÏ±Ñ
                                         </div>
                                         <div class="amount-display">${formatAmount(liabilities)}</div>
                                         <div class="ratio-display">${liabilitiesRatio}%</div>
                                     </div>
                                 </div>
                                 
                                 <!-- ÌïòÎã®: ÏûêÎ≥∏ ÏÑπÏÖò -->
                                 <div class="equity-section">
                                     <div class="section-content">
                                         <div class="section-title">
                                             <i class="fas fa-coins"></i> ÏûêÎ≥∏
                                         </div>
                                         <div class="amount-display">${formatAmount(equity)}</div>
                                         <div class="ratio-display">${equityRatio}%</div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                 `;
                 
                 document.getElementById('balanceSheetBoxes').innerHTML = boxesHTML;
                 console.log('Balance sheet boxes created successfully');
                 
             } catch (error) {
                 console.error('Error creating balance sheet boxes:', error);
                 document.getElementById('balanceSheetBoxes').innerHTML = `
                     <div class="alert alert-danger">
                         <i class="fas fa-exclamation-triangle"></i>
                         Ïû¨Î¨¥ÏÉÅÌÉúÌëú Î∞ïÏä§ ÏÉùÏÑ± Ïã§Ìå®: ${error.message}
                     </div>
                 `;
             }
         }

         // Ïû¨Î¨¥ÎπÑÏú® Ï∞®Ìä∏ Î°úÎìú
         async function loadRatioCharts(years) {
             try {
                 console.log('Loading ratio charts for years:', years);
                 const response = await fetch(`/api/chart/${corpCode}?type=ratios&years=${years}`);
                 
                 if (!response.ok) {
                     throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                 }
                 
                 const charts = await response.json();
                 console.log('Received ratio charts data:', charts);
                 
                 if (charts.error) {
                     console.error('Ratio chart error:', charts.error);
                     const errorMessage = `
                         <div class="alert alert-warning">
                             <i class="fas fa-exclamation-triangle"></i>
                             Ïû¨Î¨¥ÎπÑÏú® Ï∞®Ìä∏ ÏÉùÏÑ± Ïã§Ìå®: ${charts.error}
                         </div>
                     `;
                     document.getElementById('profitabilityChart').innerHTML = errorMessage;
                     document.getElementById('stabilityChart').innerHTML = errorMessage;
                     document.getElementById('growthChart').innerHTML = errorMessage;
                     document.getElementById('comparisonChart').innerHTML = errorMessage;
                     return;
                 }

                                 // ÏàòÏùµÏÑ± ÎπÑÏú® Ï∞®Ìä∏
                if (charts.profitability) {
                    console.log('Creating profitability chart...');
                    document.getElementById('profitabilityChart').innerHTML = ''; // Î°úÎî© Î©îÏãúÏßÄ Ï†úÍ±∞
                    Plotly.newPlot('profitabilityChart', charts.profitability.data, charts.profitability.layout);
                    console.log('Profitability chart created successfully');
                } else {
                     document.getElementById('profitabilityChart').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             ÏàòÏùµÏÑ± ÎπÑÏú® Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                         </div>
                     `;
                 }
                 
                                 // ÏïàÏ†ïÏÑ± ÎπÑÏú® Ï∞®Ìä∏
                if (charts.stability) {
                    console.log('Creating stability chart...');
                    document.getElementById('stabilityChart').innerHTML = ''; // Î°úÎî© Î©îÏãúÏßÄ Ï†úÍ±∞
                    Plotly.newPlot('stabilityChart', charts.stability.data, charts.stability.layout);
                    console.log('Stability chart created successfully');
                } else {
                     document.getElementById('stabilityChart').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             ÏïàÏ†ïÏÑ± ÎπÑÏú® Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                         </div>
                     `;
                 }
                 
                                 // ÏÑ±Ïû•ÏÑ± ÎπÑÏú® Ï∞®Ìä∏
                if (charts.growth) {
                    console.log('Creating growth chart...');
                    document.getElementById('growthChart').innerHTML = ''; // Î°úÎî© Î©îÏãúÏßÄ Ï†úÍ±∞
                    Plotly.newPlot('growthChart', charts.growth.data, charts.growth.layout);
                    console.log('Growth chart created successfully');
                } else {
                     document.getElementById('growthChart').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             ÏÑ±Ïû•ÏÑ± ÎπÑÏú® Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                         </div>
                     `;
                 }
                 
                                 // Ï¢ÖÌï© ÎπÑÏú® ÎπÑÍµê Ï∞®Ìä∏
                if (charts.comparison) {
                    console.log('Creating comparison chart...');
                    document.getElementById('comparisonChart').innerHTML = ''; // Î°úÎî© Î©îÏãúÏßÄ Ï†úÍ±∞
                    Plotly.newPlot('comparisonChart', charts.comparison.data, charts.comparison.layout);
                    console.log('Comparison chart created successfully');
                } else {
                     document.getElementById('comparisonChart').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             Ï¢ÖÌï© ÎπÑÏú® Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                         </div>
                     `;
                 }
                 
             } catch (error) {
                 console.error('Error loading ratio charts:', error);
                 const errorMessage = `
                     <div class="alert alert-danger">
                         <i class="fas fa-exclamation-triangle"></i>
                         Ïû¨Î¨¥ÎπÑÏú® Ï∞®Ìä∏ Î°úÎî© Ïã§Ìå®: ${error.message}
                     </div>
                 `;
                 document.getElementById('profitabilityChart').innerHTML = errorMessage;
                 document.getElementById('stabilityChart').innerHTML = errorMessage;
                 document.getElementById('growthChart').innerHTML = errorMessage;
                 document.getElementById('comparisonChart').innerHTML = errorMessage;
             }
         }

         // ÎãπÍ∏∞vsÏ†ÑÍ∏∞ ÎπÑÍµê Ï∞®Ìä∏ Î°úÎìú
         async function loadComparisonCharts(years) {
             try {
                 console.log('Loading comparison charts for years:', years);
                 const response = await fetch(`/api/chart/${corpCode}?type=comparison&years=${years}`);
                 
                 if (!response.ok) {
                     throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                 }
                 
                 const charts = await response.json();
                 console.log('Received comparison charts data:', charts);
                 
                 if (charts.error) {
                     console.error('Comparison chart error:', charts.error);
                     const errorMessage = `
                         <div class="alert alert-warning">
                             <i class="fas fa-exclamation-triangle"></i>
                             ÎπÑÍµê Ï∞®Ìä∏ ÏÉùÏÑ± Ïã§Ìå®: ${charts.error}
                         </div>
                     `;
                     document.getElementById('incomeComparisonChart').innerHTML = errorMessage;
                     document.getElementById('balanceComparisonChart').innerHTML = errorMessage;
                     document.getElementById('growthAnalysisChart').innerHTML = errorMessage;
                     document.getElementById('comparisonDataTable').innerHTML = errorMessage;
                     return;
                 }

                 // ÏÜêÏùµÍ≥ÑÏÇ∞ÏÑú ÎπÑÍµê Ï∞®Ìä∏
                 if (charts.income_comparison) {
                     console.log('Creating income comparison chart...');
                     document.getElementById('incomeComparisonChart').innerHTML = '';
                     Plotly.newPlot('incomeComparisonChart', charts.income_comparison.data, charts.income_comparison.layout);
                     console.log('Income comparison chart created successfully');
                 } else {
                     document.getElementById('incomeComparisonChart').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             ÏÜêÏùµÍ≥ÑÏÇ∞ÏÑú ÎπÑÍµê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                         </div>
                     `;
                 }
                 
                 // Ïû¨Î¨¥ÏÉÅÌÉúÌëú ÎπÑÍµê Ï∞®Ìä∏
                 if (charts.balance_comparison) {
                     console.log('Creating balance comparison chart...');
                     document.getElementById('balanceComparisonChart').innerHTML = '';
                     Plotly.newPlot('balanceComparisonChart', charts.balance_comparison.data, charts.balance_comparison.layout);
                     console.log('Balance comparison chart created successfully');
                 } else {
                     document.getElementById('balanceComparisonChart').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             Ïû¨Î¨¥ÏÉÅÌÉúÌëú ÎπÑÍµê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                         </div>
                     `;
                 }
                 
                 // Ï¶ùÍ∞êÎ•† Î∂ÑÏÑù Ï∞®Ìä∏
                 if (charts.growth_analysis) {
                     console.log('Creating growth analysis chart...');
                     document.getElementById('growthAnalysisChart').innerHTML = '';
                     Plotly.newPlot('growthAnalysisChart', charts.growth_analysis.data, charts.growth_analysis.layout);
                     console.log('Growth analysis chart created successfully');
                 } else {
                     document.getElementById('growthAnalysisChart').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             Ï¶ùÍ∞êÎ•† Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                         </div>
                     `;
                 }
                 
                 // ÎπÑÍµê Îç∞Ïù¥ÌÑ∞ ÌÖåÏù¥Î∏î
                 if (charts.comparison_data) {
                     console.log('Creating comparison data table...');
                     document.getElementById('comparisonDataTable').innerHTML = createComparisonTable(charts.comparison_data);
                     console.log('Comparison data table created successfully');
                 } else {
                     document.getElementById('comparisonDataTable').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             ÎπÑÍµê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                         </div>
                     `;
                 }
                 
             } catch (error) {
                 console.error('Error loading comparison charts:', error);
                 const errorMessage = `
                     <div class="alert alert-danger">
                         <i class="fas fa-exclamation-triangle"></i>
                         ÎπÑÍµê Ï∞®Ìä∏ Î°úÎî© Ïã§Ìå®: ${error.message}
                     </div>
                 `;
                 document.getElementById('incomeComparisonChart').innerHTML = errorMessage;
                 document.getElementById('balanceComparisonChart').innerHTML = errorMessage;
                 document.getElementById('growthAnalysisChart').innerHTML = errorMessage;
                 document.getElementById('comparisonDataTable').innerHTML = errorMessage;
             }
         }

         // ÎπÑÍµê Îç∞Ïù¥ÌÑ∞ ÌÖåÏù¥Î∏î ÏÉùÏÑ±
         function createComparisonTable(data) {
             let html = `
                 <div class="table-responsive">
                     <table class="table table-striped table-hover">
                         <thead class="table-dark">
                             <tr>
                                 <th>Ìï≠Î™©</th>
                                 <th>${data[0]?.previous_year}ÎÖÑ</th>
                                 <th>${data[0]?.current_year}ÎÖÑ</th>
                                 <th>Ï¶ùÍ∞êÏï°</th>
                                 <th>Ï¶ùÍ∞êÎ•†</th>
                             </tr>
                         </thead>
                         <tbody>
             `;
             
             data.forEach(item => {
                 const prevAmount = formatKoreanWon(item.previous_amount);
                 const currAmount = formatKoreanWon(item.current_amount);
                 const diffAmount = formatKoreanWon(Math.abs(item.diff_amount));
                 const growthRate = item.growth_rate;
                 const growthClass = growthRate >= 0 ? 'text-success' : 'text-danger';
                 const growthIcon = growthRate >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                 const diffSign = item.diff_amount >= 0 ? '+' : '-';
                 
                 html += `
                     <tr>
                         <td><strong>${item.item}</strong></td>
                         <td>${prevAmount}</td>
                         <td>${currAmount}</td>
                         <td class="${growthClass}">
                             <i class="fas ${growthIcon}"></i>
                             ${diffSign}${diffAmount}
                         </td>
                         <td class="${growthClass}">
                             <i class="fas ${growthIcon}"></i>
                             ${Math.abs(growthRate).toFixed(1)}%
                         </td>
                     </tr>
                 `;
             });
             
             html += `
                         </tbody>
                     </table>
                 </div>
             `;
             
             return html;
         }

         // AI Î∂ÑÏÑù Î°úÎìú
         async function loadAIAnalysis(years) {
             try {
                 const yearArray = years.split(',');
                 const latestYear = yearArray[yearArray.length - 1];
                 console.log('Loading AI analysis for years:', years);
                 
                 // AI Ïû¨Î¨¥Ï†úÌëú Î∂ÑÏÑù Î°úÎìú (Í∏∞Î≥∏Í∞í: ÏµúÏã†ÎÖÑÎèÑ)
                 loadAIFinancialAnalysis(latestYear);
                 
                 // AI ÎπÑÍµê Î∂ÑÏÑù Î°úÎìú
                 loadAIComparisonAnalysis(years);
                 
             } catch (error) {
                 console.error('Error loading AI analysis:', error);
             }
         }



         // AI Ïû¨Î¨¥Ï†úÌëú Î∂ÑÏÑù Î°úÎìú
         async function loadAIFinancialAnalysis(year) {
             if (!year) {
                 document.getElementById('aiAnalysisContent').innerHTML = `
                     <div class="alert alert-info">
                         <i class="fas fa-calendar-alt"></i>
                         ÏÉÅÎã®ÏóêÏÑú ÏÇ¨ÏóÖÏó∞ÎèÑÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.
                     </div>
                 `;
                 return;
             }

             // Î°úÎî© Ïä§ÌîºÎÑà ÌëúÏãú
             document.getElementById('aiAnalysisContent').innerHTML = `
                 <div class="loading-chart">
                     <div class="spinner-border text-primary"></div>
                     <p class="mt-3">${year}ÎÖÑ AI Î∂ÑÏÑù Ï§ë...</p>
                 </div>
             `;

             try {
                 const response = await fetch(`/api/ai-analysis/${corpCode}/${year}`);
                 
                 if (!response.ok) {
                     throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                 }
                 
                 const result = await response.json();
                 console.log('Received AI analysis data:', result);
                 
                 if (result.error) {
                     document.getElementById('aiAnalysisContent').innerHTML = `
                         <div class="alert alert-warning">
                             <i class="fas fa-exclamation-triangle"></i>
                             AI Î∂ÑÏÑù Ïã§Ìå®: ${result.error}
                         </div>
                     `;
                     return;
                 }
                 
                 if (!result.ai_enabled) {
                     document.getElementById('aiAnalysisContent').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             AI Î∂ÑÏÑù Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©ÌïòÎ†§Î©¥ Gemini API ÌÇ§Î•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.
                             <br><small>.env ÌååÏùºÏóê GEMINI_API_KEYÎ•º Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.</small>
                         </div>
                     `;
                     return;
                 }
                 
                 if (result.ai_analysis) {
                     const formattedAnalysis = formatAIAnalysis(result.ai_analysis);
                     document.getElementById('aiAnalysisContent').innerHTML = `
                         <div class="ai-analysis-content">
                             <div class="mb-3">
                                 <span class="badge bg-primary">
                                     <i class="fas fa-robot"></i> ${result.company_name} ${result.year}ÎÖÑ AI Î∂ÑÏÑù
                                 </span>
                             </div>
                             ${formattedAnalysis}
                         </div>
                     `;
                 } else {
                     document.getElementById('aiAnalysisContent').innerHTML = `
                         <div class="alert alert-warning">
                             <i class="fas fa-exclamation-triangle"></i>
                             AI Î∂ÑÏÑùÏùÑ ÏÉùÏÑ±Ìï† Ïàò ÏóÜÏäµÎãàÎã§.
                         </div>
                     `;
                 }
                 
             } catch (error) {
                 console.error('Error loading AI financial analysis:', error);
                 document.getElementById('aiAnalysisContent').innerHTML = `
                     <div class="alert alert-danger">
                         <i class="fas fa-exclamation-triangle"></i>
                         AI Î∂ÑÏÑù Î°úÎî© Ïã§Ìå®: ${error.message}
                     </div>
                 `;
             }
                 }

        // ÏÑ†ÌÉù Ïó∞ÎèÑÏôÄ Ï†ÑÎÖÑÎèÑ AI ÎπÑÍµê Î∂ÑÏÑù ÏóÖÎç∞Ïù¥Ìä∏
        async function updateAIComparisonWithPreviousYear(selectedYear) {
            const currentYear = parseInt(selectedYear);
            const previousYear = currentYear - 1;
            
            console.log(`AI ÎπÑÍµê Î∂ÑÏÑù ÏóÖÎç∞Ïù¥Ìä∏: ${previousYear}ÎÖÑ vs ${currentYear}ÎÖÑ`);
            
            // AI ÎπÑÍµê Î∂ÑÏÑù Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('aiComparisonTitle').innerHTML = `
                <i class="fas fa-chart-line text-success"></i> AI ÎπÑÍµê Î∂ÑÏÑù 
                <span class="badge bg-success ms-2">${previousYear}ÎÖÑ vs ${currentYear}ÎÖÑ</span>
            `;
            
            // AI ÎπÑÍµê Î∂ÑÏÑù ÏÑπÏÖòÏùÑ Î°úÎî© ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤Ω
            document.getElementById('aiComparisonContent').innerHTML = `
                <div class="loading-chart">
                    <div class="spinner-border text-success"></div>
                    <p class="mt-3">${previousYear}ÎÖÑ vs ${currentYear}ÎÖÑ AI ÎπÑÍµê Î∂ÑÏÑù Ï§ë...</p>
                </div>
            `;
            
            // ÏÑ†ÌÉù Ïó∞ÎèÑÏôÄ Ï†ÑÎÖÑÎèÑÎ°ú ÎπÑÍµê Î∂ÑÏÑù Ïã§Ìñâ
            await loadAIComparisonAnalysis(`${previousYear},${currentYear}`);
        }

        // AI ÎπÑÍµê Î∂ÑÏÑù Î°úÎìú
        async function loadAIComparisonAnalysis(years) {
             try {
                 const response = await fetch(`/api/ai-comparison/${corpCode}?years=${years}`);
                 
                 if (!response.ok) {
                     throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                 }
                 
                 const result = await response.json();
                 console.log('Received AI comparison data:', result);
                 
                 if (result.error) {
                     document.getElementById('aiComparisonContent').innerHTML = `
                         <div class="alert alert-warning">
                             <i class="fas fa-exclamation-triangle"></i>
                             AI ÎπÑÍµê Î∂ÑÏÑù Ïã§Ìå®: ${result.error}
                         </div>
                     `;
                     return;
                 }
                 
                 if (!result.ai_enabled) {
                     document.getElementById('aiComparisonContent').innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle"></i>
                             AI Î∂ÑÏÑù Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©ÌïòÎ†§Î©¥ Gemini API ÌÇ§Î•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.
                         </div>
                     `;
                     return;
                 }
                 
                 if (result.ai_analysis) {
                     const formattedAnalysis = formatAIAnalysis(result.ai_analysis);
                     document.getElementById('aiComparisonContent').innerHTML = `
                         <div class="ai-analysis-content">
                             <div class="mb-3">
                                 <span class="badge bg-success">
                                     <i class="fas fa-chart-line"></i> ${result.company_name} ${result.previous_year} vs ${result.current_year} AI ÎπÑÍµêÎ∂ÑÏÑù
                                 </span>
                             </div>
                             ${formattedAnalysis}
                         </div>
                     `;
                 } else {
                     document.getElementById('aiComparisonContent').innerHTML = `
                         <div class="alert alert-warning">
                             <i class="fas fa-exclamation-triangle"></i>
                             AI ÎπÑÍµê Î∂ÑÏÑùÏùÑ ÏÉùÏÑ±Ìï† Ïàò ÏóÜÏäµÎãàÎã§.
                         </div>
                     `;
                 }
                 
             } catch (error) {
                 console.error('Error loading AI comparison analysis:', error);
                 document.getElementById('aiComparisonContent').innerHTML = `
                     <div class="alert alert-danger">
                         <i class="fas fa-exclamation-triangle"></i>
                         AI ÎπÑÍµê Î∂ÑÏÑù Î°úÎî© Ïã§Ìå®: ${error.message}
                     </div>
                 `;
             }
         }

         // AI Î∂ÑÏÑù Í≤∞Í≥º Ìè¨Îß∑ÌåÖ
         function formatAIAnalysis(analysisText) {
             if (!analysisText) return '';
             
             // ÎßàÌÅ¨Îã§Ïö¥ Ïä§ÌÉÄÏùº Ìó§Îî©ÏùÑ HTMLÎ°ú Î≥ÄÌôò
             let formatted = analysisText
                 .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                 .replace(/^(\d+\.\s*\*\*.*?\*\*)/gm, '<h6 class="mt-3 text-primary">$1</h6>')
                 .replace(/\n\n/g, '</p><p>')
                 .replace(/\n/g, '<br>');
             
             // Ïù¥Î™®ÏßÄÏôÄ Ìï®Íªò ÏÑπÏÖò Íµ¨Î∂Ñ
             formatted = formatted
                 .replace(/üìä/g, '<i class="fas fa-chart-bar text-info"></i>')
                 .replace(/üí∞/g, '<i class="fas fa-coins text-warning"></i>')
                 .replace(/üè¶/g, '<i class="fas fa-university text-primary"></i>')
                 .replace(/üìà/g, '<i class="fas fa-chart-line text-success"></i>')
                 .replace(/‚ö†Ô∏è/g, '<i class="fas fa-exclamation-triangle text-warning"></i>')
                 .replace(/üéØ/g, '<i class="fas fa-bullseye text-danger"></i>')
                 .replace(/üìâ/g, '<i class="fas fa-chart-line-down text-danger"></i>')
                 .replace(/üîç/g, '<i class="fas fa-search text-info"></i>');
             
             return `<div class="ai-analysis-text">${formatted}</div>`;
         }

         // ÌÉ≠ Ï†ÑÌôò Ïãú Ï∞®Ìä∏ Î¶¨ÏÇ¨Ïù¥Ï¶à
        document.addEventListener('shown.bs.tab', function (event) {
            setTimeout(() => {
                Plotly.Plots.resize('revenueChart');
                Plotly.Plots.resize('profitChart');
                Plotly.Plots.resize('assetsChart');
                Plotly.Plots.resize('debtEquityChart');
                Plotly.Plots.resize('profitabilityChart');
                Plotly.Plots.resize('stabilityChart');
                Plotly.Plots.resize('growthChart');
                Plotly.Plots.resize('comparisonChart');
                Plotly.Plots.resize('incomeComparisonChart');
                Plotly.Plots.resize('balanceComparisonChart');
                Plotly.Plots.resize('growthAnalysisChart');
            }, 100);
        });
    </script>
</body>
</html> 